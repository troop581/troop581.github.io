"use strict";var app=angular.module("app",["ngRoute","ngSanitize","ui.bootstrap"]);app.config(["$tooltipProvider","$routeProvider","$httpProvider","$locationProvider",function(e,t,a,r){e.options({popupDelay:500}),a.defaults.withCredentials=!0,t.when("/flags",{title:"Flags",templateUrl:"app/modules/flags.html",resolve:{dataService:function(e){return e.init()}}}).when("/flyer",{title:"Flyer",templateUrl:"app/modules/flyer.html",resolve:{dataService:function(e){return e.init()}}}).when("/success",{title:"Thank you",templateUrl:"app/modules/success.html",resolve:{dataService:function(e){return e.init()}}}).when("/requirements",{title:"Requirements",templateUrl:"app/modules/requirements.html",resolve:{dataService:function(e){return e.init()}}}).otherwise({redirectTo:"/flags"})}]),app.run(["$route","$rootScope",function(e,r){r.$on("$routeChangeSuccess",function(e,t,a){r.title="Troop 581 - "+t.$$route.title})}]),toastr.options={closeButton:!1,debug:!1,positionClass:"toast-bottom-left",onclick:null,showDuration:"4000",hideDuration:"1000",timeOut:"4000",extendedTimeOut:"1000",showEasing:"linear",hideEasing:"linear",showMethod:"show",hideMethod:"hide"},app.controller("header",["$location","dataService",function(e,t){var a=this;return a.data=t,a.location=e,a}]),app.controller("shell",["$location","$modal","dataService",function(t,e,a){var r=this;return r.data=a,r.isActive=function(e){return e===t.path().substr(0,e.length)},r.openSettings=function(){e.open({templateUrl:"app/modules/settings.html",controller:"settings as vm"}).result.then(function(){},function(){})},r}]),app.controller("flags.boundaries",["dataService","$modalInstance","$q",function(e,t,a){var r=this;return r.data=e,r.close=function(){t.close()},r}]),app.controller("flags",["dataService","$q","$modal","$timeout","$filter",function(t,e,a,r,n){var o=this;return o.data=t,o.autosave=function(){localStorage.setItem("flags.values",JSON.stringify(t.values))},o.donate=function(e){return toastr.clear(),t.values.subscribe||t.values.donate?t.values.donate&&!t.values.donation?(toastr.warning("","You selected to give a donation but did not enter an amount."),void e.preventDefault()):t.values.donation&&(!_.toNumber(t.values.donation)||parseInt(t.values.donation,10)<0)?(toastr.warning("","Please check your donation amount. It doesn't appear to be correct."),void e.preventDefault()):t.values.subscribe&&o.getTotal()<t.cost?(toastr.error("","An error occurred. Please fix the data and try again.",{timeOut:0}),void e.preventDefault()):o.getTotal()<5?(toastr.warning("","$5.00 is the minimum amount we can process through PayPal."),void e.preventDefault()):!t.values.name||!t.values.address&&t.values.subscribe?(toastr.warning("","Please fill in all required fields."),void e.preventDefault()):(toastr.info("","You will now be sent to PayPal to finish the transaction.",{timeOut:0}),void r(function(){},5e3)):(toastr.warning("","You have not selected the flag service or a donation."),void e.preventDefault())},o.getDescription=function(){var e="";return t.values.subscribe?(e+=t.year+" Flag Subscription",t.values.donate&&t.values.donation&&(e+=" and Donation of "+n("currency")(t.values.donation,"$",2))):t.values.donate&&t.values.donation&&(e+="Donation of "+n("currency")(t.values.donation,"$",2)),e},o.getDonation=function(){return _.toNumber(t.values.donation)?parseInt(t.values.donation,10)<0?0:parseInt(t.values.donation,10):0},o.getTotal=function(){var e=0;return t.values.subscribe&&(e+=t.cost),t.values.donate&&(e+=o.getDonation()),e},o.showBoundaries=function(){toastr.clear(),a.open({templateUrl:"app/modules/flags.boundaries.html",controller:"flags.boundaries as vm",size:"lg"}).result.then(function(){},function(){})},t.values=JSON.parse(localStorage.getItem("flags.values"))||{},o}]),app.controller("flyer",["dataService","$q","$modal","$timeout","$filter",function(e,t,a,r,n){return this.data=e,this}]),app.controller("requirements",["dataService","$q","$modal",function(s,a,t){var e=this;return e.data=s,e.meritBadgeUrl="meritbadge.org/wiki/index.php/Merit_Badges",e.rankUrl="meritbadge.org/wiki/index.php/Main_Page",e.refresh=function(){return s.processingRequirements=!0,s.failures={ranks:[],meritBadges:[]},a.all({ranks:(s.ranksTemp={Scout:{order:1,name:"Scout",url:"meritbadge.org/wiki/index.php/Scout_Badge",encodedName:"BoyScout",type:"Rank"},Tenderfoot:{order:2,name:"Tenderfoot",url:"meritbadge.org/wiki/index.php/Tenderfoot_rank",encodedName:"Tenderfoot",type:"Rank"},"Second Class":{order:3,name:"Second Class",url:"meritbadge.org/wiki/index.php/Second_Class_rank",encodedName:"SecondClass",type:"Rank"},"First Class":{order:4,name:"First Class",url:"meritbadge.org/wiki/index.php/First_Class_rank",encodedName:"FirstClass",type:"Rank"},Star:{order:5,name:"Star",url:"meritbadge.org/wiki/index.php/Star_rank",encodedName:"Star",type:"Rank"},Life:{order:6,name:"Life",url:"meritbadge.org/wiki/index.php/Life_rank",encodedName:"Life",type:"Rank"},Eagle:{order:7,name:"Eagle",url:"meritbadge.org/wiki/index.php/Eagle_Scout_rank",encodedName:"EagleScout",type:"Rank"},"Eagle Palms":{order:8,name:"Eagle Palms",url:"meritbadge.org/wiki/index.php/Eagle_Palms",encodedName:"Eagle_Palms",type:"Palm"}},a.all(_.map(s.ranksTemp,function(i){return a.all({requirements:s.getWebpage(i.url,"table","xml").then(function(e){var t=$(e).find("table").has(".mw-headline"),a=$(t).find("tr:first")[0]&&$(t).find("tr:first")[0].outerHTML||"",r=$(t).find("table:last")[0]&&$(t).find("table:last")[0].outerHTML||"",n=$(t).find("div:last")[0]&&$(t).find("div:last")[0].outerHTML||"",o=$(e).find("table").has(".mw-headline")[0].outerHTML;o=_.replace(o,a,""),o=_.replace(o,r,""),o=_.replace(o,n,""),s.ranksTemp[i.name].requirements=o}),image:s.getWebpage(i.url,"img","json").then(function(e){var t;e=_.castArray(e),_.forEach(e,function(e){if(e.src&&_.includes(e.src,i.encodedName))return t=e,!1}),t&&(s.ranksTemp[i.name].imgUrl="//meritbadge.org"+t.src)})}).then(function(e){s.ranksTemp[i.name].ready=!0,s.ranks[i.name]=s.ranksTemp[i.name]},function(e){console.log(i.name+" failed: "+e),s.failures.ranks.push(i)})})).finally(function(e){localStorage.setItem("ranks",JSON.stringify(s.ranks))})),meritBadges:(s.meritBadgesTemp={},s.getWebpage(e.meritBadgeUrl,"ol","json").then(function(e){var t;return e=_.castArray(e),_.forEach(e,function(e){if(e.li&&100<e.li.length)return t=e.li,!1}),_.forEach(t,function(e){_.has(e,"a.content")?s.meritBadgesTemp[e.a.content]={name:e.a.content,url:"meritbadge.org"+_.get(e,"a.href"),encodedName:_.replace(_.get(e,"a.href"),"/wiki/index.php/",""),type:"Merit Badge"}:_.has(e,"i.b.a.content")&&(s.meritBadgesTemp[e.i.b.a.content]={name:e.i.b.a.content,url:"meritbadge.org"+_.get(e,"i.b.a.href"),encodedName:_.replace(_.get(e,"i.b.a.href"),"/wiki/index.php/",""),type:"Merit Badge",required:!0})}),a.all(_.map(s.meritBadgesTemp,function(i){return a.all({requirements:s.getWebpage(i.url,"table","xml").then(function(e){var t=$(e).find("table").has(".mw-headline"),a=$(t).find("tr:first")[0]&&$(t).find("tr:first")[0].outerHTML||"",r=$(t).find("table:last")[0]&&$(t).find("table:last")[0].outerHTML||"",n=$(t).find("div:last")[0]&&$(t).find("div:last")[0].outerHTML||"",o=$(e).find("table").has(".mw-headline")[0].outerHTML;o=_.replace(o,a,""),o=_.replace(o,r,""),o=_.replace(o,n,""),s.meritBadgesTemp[i.name].requirements=o}),image:s.getWebpage(i.url,"img","json").then(function(e){var t;e=_.castArray(e),_.forEach(e,function(e){if(e.src&&_.includes(e.src,i.encodedName))return t=e,!1}),t&&(s.meritBadgesTemp[i.name].imgUrl="//meritbadge.org"+t.src)})}).then(function(e){s.meritBadgesTemp[i.name].ready=!0,s.meritBadges[i.name]=s.meritBadgesTemp[i.name]},function(e){console.log(i.name+" failed: "+e),s.failures.meritBadges.push(i)})})).finally(function(e){localStorage.setItem("meritBadges",JSON.stringify(s.meritBadges))})}))}).finally(function(e){s.processingRequirements=!1})},e.showRequirements=function(e){t.open({templateUrl:"app/modules/requirements.show.html",controller:"requirements.show as vm",size:"lg",resolve:{badge:function(){return e}}}).result.then(function(){},function(){})},!s.processingRequirements&&_.isEmpty(s.meritBadges)&&_.isEmpty(s.ranks)&&e.refresh(),e}]),app.controller("requirements.show",["dataService","$modalInstance","$q","badge",function(e,t,a,r){var n=this;return n.data=e,n.title="",n.badge=r,n.close=function(){t.close()},t.rendered.then(function(){$("#requirements").html(r.requirements),$("#requirements table").removeAttr("style"),$("#requirements a").replaceWith(function(){return $(this)[0].innerText})}),n}]),app.controller("success",["dataService","$q","$modal","$timeout","$filter",function(e,t,a,r,n){return this.data=e,this}]),app.factory("dataService",["$http","$filter","$q",function(r,e,t){var a={year:2018,cost:45,meritBadges:{},values:{}};function n(e,t,a,r){var n=moment().year(r).month(a).date(1).hours(0).minutes(0).seconds(0).milliseconds(0);if(-1===e)for(n.endOf("month").startOf("day");n.day()!==t;)n.subtract(1,"day");else for(n.date(7*(e-1)+1);n.day()!==t;)n.add(1,"day");return n}return a.holidays=[{text:"Memorial Day",date:n(-1,1,4,a.year),dateNoYear:"Last Monday in May"},{text:"Flag Day",date:moment(a.year+"-06-14"),dateNoYear:"June 14th"},{text:"Independence Day",date:moment(a.year+"-07-04"),dateNoYear:"July 4th"},{text:"Patriot Day",date:moment(a.year+"-09-11"),dateNoYear:"September 11th"},{text:"Columbus Day",date:n(2,1,9,a.year),dateNoYear:"Second Monday in October"},{text:"Veterans Day",date:moment(a.year+"-11-11"),dateNoYear:"November 11th"},{text:"Martin Luther King, Jr. Day",date:n(3,1,0,a.year+1),dateNoYear:"Third Monday in January"},{text:"Presidents' Day",date:n(3,1,1,a.year+1),dateNoYear:"Third Monday in February"}],a.getWebpage=function(e,t,a){return r.get("https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D'"+encodeURI(e)+"'%20and%20xpath%3D'%2F%2F"+t+"'&format="+a+"&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys",{withCredentials:!1}).then(function(e){return"json"===a?e.data.query.results[t]:$.parseXML(e.data)})},a.processDonation=function(e){return r.get(e).then(function(e){return e})},a.init=function(){a.ranks=JSON.parse(localStorage.getItem("ranks"))||{},a.meritBadges=JSON.parse(localStorage.getItem("meritBadges"))||{}},a}]),app.directive("dropTarget",function(e){return{restrict:"A",scope:{drop:"&"},link:function(a,e,t,r){var n=0;e.bind("dragover",function(e){e.preventDefault&&e.preventDefault(),e.stopPropogation&&e.stopPropogation(),e.originalEvent.dataTransfer.dropEffect="copy"}),e.bind("dragenter",function(e){n++,e.preventDefault&&e.preventDefault(),e.stopPropogation&&e.stopPropogation(),e.originalEvent.dataTransfer.dropEffect="copy",angular.element(e.currentTarget).addClass("alert-success"),angular.element(e.currentTarget).removeClass("alert-info")}),e.bind("dragleave",function(e){0===--n&&(angular.element(e.currentTarget).addClass("alert-info"),angular.element(e.currentTarget).removeClass("alert-success")),e.preventDefault&&e.preventDefault(),e.stopPropogation&&e.stopPropogation(),e.originalEvent.dataTransfer.dropEffect="copy"}),e.bind("drop",function(e){e.preventDefault&&e.preventDefault(),e.stopPropogation&&e.stopPropogation(),angular.element(e.currentTarget).addClass("alert-info"),angular.element(e.currentTarget).removeClass("alert-success");var t=e.originalEvent.dataTransfer.files;a.$apply(function(){a.drop({files:t})})})}}}),app.directive("floatThead",function(){return{restrict:"A",link:function(e,t,a){$(t).floatThead()}}}),app.filter("momentToString",["$filter","$locale",function(e,t){return function(e,t){return moment.isMoment(e)?e.format(t):""}}]),app.filter("objToArray",["$filter",function(e){return function(e){return e instanceof Object?_.values(e):e}}]),app.filter("porgSite",["$filter",function(e){return function(e,t){var a=[];return _.forEach(e,function(e){"all"!==t&&e.parentPOrg!==t||a.push(e)}),a}}]);