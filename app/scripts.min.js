"use strict";var app=angular.module("app",["ngRoute","ngSanitize","ui.bootstrap"]);app.config(["$tooltipProvider","ngQuickDateDefaultsProvider","$routeProvider","$httpProvider",function(n,t,i,r){n.options({popupDelay:500});r.defaults.withCredentials=!0;i.when("/flags",{templateUrl:"app/modules/flags.html",resolve:{dataService:function(n){return n.init()}}}).otherwise({redirectTo:"/flags"})}]);app.run(["$route",function(){}]);toastr.options={closeButton:!1,debug:!1,positionClass:"toast-bottom-left",onclick:null,showDuration:"4000",hideDuration:"1000",timeOut:"4000",extendedTimeOut:"1000",showEasing:"linear",hideEasing:"linear",showMethod:"show",hideMethod:"hide"};app.controller("asl",["dataService","$q",function(n){var t=this;return t.data=n,function(){}(),t}]);app.controller("dashboard",["dataService","$q","$location","$modal",function(n,t,i,r){function f(){n.dashboard.forecasts={};n.dashboard.forecasts.cm={};n.dashboard.forecasts.all=[];n.dashboard.forecasts.singleOa=[];n.dashboard.forecasts.noOa=[];n.dashboard.forecasts.multipleOa=[];n.dashboard.forecastGroup={};var u,r,i,t,f;_.forEach(n.dashboard.rawForecasts,function(f,e){u=_.where(n.dashboard.valid,function(n){return n.Material===e});_.forEach(f,function(f,o){r=_.where(u,function(n){return _.where(n.Sites,function(n){return n.sloc===o}).length>0});_.forEach(f,function(u,f){t={material:e,site:o,rdd:f,qty:u};r.length===1?(i=r[0],t.oaLine=i,t.site=_.find(i.Sites,{sloc:o})||{site:o},t.oaStart=moment.max(moment(i.VperStart),moment(i.ConditionStart)).format("YYYY-MM-DD"),t.oaEnd=moment.min(moment(i.VperEnd),moment(i.ConditionEnd)).format("YYYY-MM-DD"),t.pnd=moment(t.rdd).subtract(i.PlanDel,"days").subtract(t.site.ShippingCondition.transitTime,"days").subtract(n.fixedVal.defaults.emsPndBuffer,"days").format("YYYY-MM-DD"),t.pndInPast=moment(t.pnd).isBefore(moment(),"day"),t.pndInPast?(t.dueDate=t.oaEnd,t.invalidOa=moment(t.oaStart).isAfter(moment(),"day")||moment(t.oaEnd).isBefore(moment(),"day")):(t.dueDate=moment(t.pnd).subtract(n.fixedVal.defaults.forecastBuffer,"days").format("YYYY-MM-DD"),t.invalidOa=moment(t.oaStart).isAfter(moment(t.pnd),"day")||moment(t.oaEnd).isBefore(moment(t.pnd),"day")),t.daysToPnd=moment(t.pnd).startOf("day").diff(moment().startOf("day"),"days"),t.daysToDue=moment(t.dueDate).startOf("day").diff(moment().startOf("day"),"days"),t.withinNotice=t.daysToDue<=t.oaLine.SIITMRequotingTime,t.actionNeeded=(t.invalidOa||t.pndInPast)&&t.withinNotice,t.overdue=t.daysToDue<1,t.expired=moment(t.oaEnd).isBefore(moment(),"day"),n.dashboard.forecasts.singleOa.push(t),n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup]||(n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup]={},n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].label=t.oaLine.PurGroup.Description,n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].code=t.oaLine.PurGroup.PurGroup,n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites={},n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.all=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.actionNeeded=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.almostDue=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.due=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.pastDuePndFuture=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.pastDuePndPast=[]),n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site]||(n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site]={},n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].all=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].actionNeeded=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].almostDue=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].due=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].pastDuePndFuture=[],n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].pastDuePndPast=[]),n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.all.push(t),n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].all.push(t),t.actionNeeded&&(n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.actionNeeded.push(t),n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].actionNeeded.push(t),t.daysToDue>parseInt(n.fixedVal.defaults.daysToDue,10)?(n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.almostDue.push(t),n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].almostDue.push(t)):t.daysToDue>0?(n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.due.push(t),n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].due.push(t)):t.daysToPnd>0?(n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.pastDuePndFuture.push(t),n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].pastDuePndFuture.push(t)):(n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup].allSites.pastDuePndPast.push(t),n.dashboard.forecasts.cm[t.oaLine.PurGroup.PurGroup][t.site.site].pastDuePndPast.push(t)))):r.length<1?n.dashboard.forecasts.noOa.push(t):(t.oaLines=r,t.site=_.find(r[0].Sites,{sloc:o})||{site:o},n.dashboard.forecasts.multipleOa.push(t));n.dashboard.forecasts.all.push(t)})})});_.forEach(n.dashboard.forecasts.cm,function(i,r){n.dashboard.forecastGroup[r]={};n.dashboard.forecastGroup[r].allSites={};n.dashboard.forecastGroup[r].allSites.all=[];n.dashboard.forecastGroup[r].allSites.actionNeeded=[];n.dashboard.forecastGroup[r].allSites.almostDue=[];n.dashboard.forecastGroup[r].allSites.due=[];n.dashboard.forecastGroup[r].allSites.pastDuePndFuture=[];n.dashboard.forecastGroup[r].allSites.pastDuePndPast=[];n.dashboard.forecastGroup[r].label=i.label;n.dashboard.forecastGroup[r].code=i.code;f=_.groupBy(i.allSites.all,function(n){return n.oaLine.Contract+"_"+n.oaLine.ItemNo});_.forEach(f,function(i){var u,f,e;t={};t.oaLine=i[0].oaLine;t.material=i[0].material;t.oaStart=i[0].oaStart;t.oaEnd=i[0].oaEnd;t.expired=i[0].expired;t.siteString=_.sortBy(_.uniq(_.map(i,function(n){return n.site.site}))).join(", ");t.qty=_.reduce(i,function(n,t){return n+t.qty},0);t.pndInPast=_.some(i,"pndInPast");t.invalidOa=_.some(i,"invalidOa");t.actionNeeded=_.some(i,"actionNeeded");t.withinNotice=_.some(i,"withinNotice");t.overdue=_.some(i,"overdue");u=_.min(i,"daysToPnd");t.pnd=u.pnd;t.daysToPnd=u.daysToPnd;f=_.min(i,"daysToDue");t.dueDate=f.dueDate;t.daysToDue=f.daysToDue;e=_.max(i,"daysToPnd");t.latestPnd=e.pnd;t.daysToLatestPnd=e.daysToPnd;n.dashboard.forecastGroup[r].allSites.all.push(t);t.actionNeeded&&(n.dashboard.forecastGroup[r].allSites.actionNeeded.push(t),t.daysToDue>parseInt(n.fixedVal.defaults.daysToDue,10)?n.dashboard.forecastGroup[r].allSites.almostDue.push(t):t.daysToDue>0?n.dashboard.forecastGroup[r].allSites.due.push(t):t.daysToPnd>0?n.dashboard.forecastGroup[r].allSites.pastDuePndFuture.push(t):n.dashboard.forecastGroup[r].allSites.pastDuePndPast.push(t))})});n.dashboard.forecastCm=n.dashboard.forecasts.cm[n.settings.cm&&n.settings.cm.PurGroup];n.materialIndex=_.groupBy(n.dashboard.forecasts.multipleOa,"material");_.forEach(n.materialIndex,function(t,i){n.getMaterialDetails(i).then(function(t){n.materialIndex[i]={};t.data&&(n.materialIndex[i].MMDesc=t.data.MMDesc,n.materialIndex[i].SynergyLevel=t.data.SlInd,n.materialIndex[i].SynergyModel=t.data.SlSupplierPartNum,n.materialIndex[i].SynergySupplier=t.data.SlSupplierName,n.materialIndex[i].SupItemSubcategoryNm=t.data.SupItemSubcategoryNm)})})}var u=this;return u.data=n,u.location=i,u.showOther=!1,u.displayBom=function(t){var i;n.dashboard.bomNoOa=[];n.dashboard.bomMultipleOa=[];_.forEach(n.dashboard.bomTotal,function(r){i=_.where(n.dashboard.valid,function(n){return n.Material===r.value&&_.where(n.Sites,function(n){return n.site===t}).length>0});i.length===0?(r.hasForecast=!!n.dashboard.rawForecasts[r.value],n.dashboard.bomNoOa.push(r)):i.length>1&&(r.hasForecast=!!n.dashboard.rawForecasts[r.value],r.lines=i,n.dashboard.bomMultipleOa.push(r))});_.forEach(n.dashboard.bomNoOa,function(t){n.getMaterialDetails(t.value).then(function(n){n.data&&(t.MMDesc=n.data.MMDesc,t.SynergyLevel=n.data.SlInd,t.SynergyModel=n.data.SlSupplierPartNum,t.SynergySupplier=n.data.SlSupplierName,t.SupItemSubcategoryNm=n.data.SupItemSubcategoryNm)})});_.forEach(n.dashboard.bomMultipleOa,function(t){n.getMaterialDetails(t.value).then(function(n){n.data&&(t.MMDesc=n.data.MMDesc,t.SynergyLevel=n.data.SlInd,t.SynergyModel=n.data.SlSupplierPartNum,t.SynergySupplier=n.data.SlSupplierName,t.SupItemSubcategoryNm=n.data.SupItemSubcategoryNm)})})},u.getDashboardLines=function(){toastr.clear();toastr.info("This may take several seconds.","Retrieving dashboard data...",{timeOut:0});u.processing=!0;var o=moment(),r="",e="";n.dashboard.forecastDetails=[];r="(DocType eq 'ZCON' or DocType eq 'ZQUO')";r+=n.settings.category?" and PurchOrg eq '"+encodeURIComponent(n.settings.category)+"'":" and PurchOrg eq 'S044'";e=r;r+=" and ConditionDataFlag eq 'X' and TextDataFlag eq 'X'";t.all([t.all([n.getLines(r),n.getExtensions(e)]).then(function(t){n.dashboard.timestamp=o.toDate();n.dashboard.lines=n.mapExtensions(t[0].data,t[1].data);n.dashboard.valid=_.where(n.dashboard.lines,function(n){return n.DeleteInd!=="X"&&n.SIActive.value==="X"&&n.SIStatus.value==="A"});n.dashboard.groupedLines={};n.dashboard.groupedLines=_.groupBy(n.dashboard.lines,function(n){return n.PurGroup.PurGroup});n.dashboard.groups=[];_.forEach(_.sortBy(_.keys(n.dashboard.groupedLines)),function(t,i){n.dashboard.groups[i]={};n.dashboard.groups[i].code=t;n.dashboard.groups[i].label=_.find(n.purGroup,{PurGroup:t})&&_.find(n.purGroup,{PurGroup:t}).Description||"";n.dashboard.groups[i].all=_.where(n.dashboard.groupedLines[t],function(n){return n.DeleteInd!=="X"});n.dashboard.groups[i].preferred=_.where(n.dashboard.groups[i].all,function(n){return n.SIActive.value==="X"});n.dashboard.groups[i].notPreferred=_.where(n.dashboard.groups[i].all,function(n){return n.SIActive.value==="N"});n.dashboard.groups[i].obsolete=_.where(n.dashboard.groups[i].all,function(n){return n.SIActive.value==="O"});n.dashboard.groups[i].other=_.where(n.dashboard.groups[i].all,function(n){return n.SIActive.value!=="X"&&n.SIActive.value!=="N"&&n.SIActive.value!=="O"});n.dashboard.groups[i].preferredApproved=_.where(n.dashboard.groups[i].all,function(n){return n.SIActive.value==="X"&&n.SIStatus.value==="A"});n.dashboard.groups[i].notApproved=_.where(n.dashboard.groups[i].all,function(n){return n.SIStatus.value!=="A"});n.dashboard.groups[i].pendingCm=_.where(n.dashboard.groups[i].all,function(n){return n.SICMApproval.value==="P"});n.dashboard.groups[i].pendingSite=_.where(n.dashboard.groups[i].all,function(n){return n.SISiteApproval.value==="P"});n.dashboard.groups[i].pendingTd=_.where(n.dashboard.groups[i].all,function(n){return n.SITDApproval.value==="P"})});n.dashboard.statusFilter=_.find(n.dashboard.groups,{code:n.settings.cm&&n.settings.cm.PurGroup});u.updateShowOther(n.dashboard.statusFilter);toastr.clear();toastr.success("","Dashboard data retrieved!");u.processing=!1;n.dashboard.loaded=!0}),n.getBom().then(function(t){n.dashboard.bomCount=_.countBy(t.data,"value");n.dashboard.bomTotal=_.forEach(_.toArray(_.indexBy(t.data,"value")),function(t){t.count=n.dashboard.bomCount[t.value]})}),n.getForecasts(n.fixedVal.forecast[i.host()]).then(function(t){n.dashboard.rawForecasts=t.data})]).then(function(){f();u.displayBom(n.dashboard.bomSite)})},u.getDays=function(n){return!n||parseInt(n,10)!==1&&parseInt(n,10)!==-1?"days":"day"},u.relatedOas=function(n){var t=r.open({templateUrl:"app/modules/dashboard.mm.html",controller:"dashboard.mm as vm",size:"lg",resolve:{material:function(){return n}}});t.result.then(function(){},function(){})},u.updateShowOther=function(t){var i=!1;t?!!t.other&&t.other.length>0&&(i=!0):_.forEach(n.dashboard.groups,function(n){if(n.other.length>0)return i=!0,!1});u.showOther=i},u.viewStatus=function(t){t.length>0&&(n.contractLines=t,n.search.expanded=!1,i.path("/search"))},function(){u.updateShowOther(n.dashboard.statusFilter);n.settings.autoPull&&!n.dashboard.loaded&&u.getDashboardLines()}(),u}]);app.controller("dashboard.mm",["material","dataService","$modalInstance","$q",function(n,t,i,r){function o(){u.processing=!0;var i="",f="";i="(DocType eq 'ZCON' or DocType eq 'ZQUO') and Material eq '"+n+"'";f=i;i+=" and ConditionDataFlag eq 'X' and TextDataFlag eq 'X'";r.all([t.getLines(i),t.getExtensions(f)]).then(function(n){u.relatedOas=t.mapExtensions(n[0].data,n[1].data)}).finally(function(){u.processing=!1})}var u=this,f,e;return u.data=t,u.material=n,u.relatedOas=[],u.processing=!1,f="Contract,ItemNo,DocType,VendorName,VperStart,VperEnd,PurchOrg,Material,ShortText,ConditionStart,ConditionEnd,VendMat,SIActive,SIStatus,DeleteInd",e="Contract,ItemNo,Plant,StgeLoc,DeletionInd",u.close=function(){i.close()},function(){o()}(),u}]);app.controller("document",["dataService","$q","$routeParams","$filter","$location",function(n,t,i,r){var u=this;return u.data=n,u.processing=!1,u.uploaded=!1,u.drop=function(n){n.length===1?(u.file=n[0],u.uploaded=!1):n.length>1&&(toastr.clear(),toastr.error("","Please select only one file.",{timeOut:0}))},u.upload=function(){u.processing=!0;toastr.clear();toastr.info("","Uploading "+u.file.name,{timeOut:0});n.fetchToken().then(function(){var t={headers:{slug:"smw - Test,"+u.file.name+",AMAT,11/20/2014,11/20/2015","x-csrf-token":n.token}};n.uploadDocument(u.file,t).then(function(n){u.uploaded=!0;toastr.clear();toastr.success("Document "+r("removeZeros")(n.data.d.Documentnumber)+" created",u.file.name+" successfully uploaded!")},function(n){toastr.clear();toastr.error("Error "+n.status,"An unknown error occurred.",{timeOut:0})}).finally(function(){u.processing=!1})})},function(){}(),u}]);app.controller("outlineAgreement",["dataService","$q","$routeParams","$filter","$location","$anchorScroll",function(n,t,i,r,u,f){function a(t){n.contractRecent.unshift(t);n.contractRecent=_.uniq(n.contractRecent);n.contractRecent.length>10&&(n.contractRecent.length=10);localStorage.setItem("sombrero.contractRecent",JSON.stringify(n.contractRecent))}function v(n){for(var i="",r=new Uint8Array(n),u=r.byteLength,t=0;t<u;t++)i+=String.fromCharCode(r[t]);return window.btoa(i)}function o(n){return n?moment((n-25569)*864e5+moment().zone()*6e4).format("YYYY/MM/DD"):""}function l(i,r){var u="Contract eq '"+i+"' and TextDataFlag eq 'X'",f="Contract eq '"+i+"' and TextDataFlag eq 'X' and ConditionDataFlag eq 'X'",o="Contract eq '"+i+"'";return n.contractCheckAll=!1,t.all([n.getHeader(u),n.getLines(f),n.getExtensions(o)]).then(function(u){return u[0].data?t.when(_.forEach(u[1].data,function(n){n.Material={value:n.Material}})).then(function(){var t=u[0].data,f=n.mapExtensions(u[1].data,u[2].data,t.PurchOrg);t.Lines=f;n.contract=t;r?e.activateContractLine(_.find(n.contract.Lines,{ItemNo:r})||_.first(n.contract.Lines)):e.activateContractLine(_.first(n.contract.Lines));n.contractReady=!0;a(i);toastr.clear()}):(toastr.clear(),toastr.warning("Could not find OA "+i,"",{timeOut:0})),u},function(n){toastr.clear();n.data.hasOwnProperty("error")?toastr.error(n.status+": "+n.data.error.message.value,"",{timeOut:0}):toastr.error("","An error occurred.  Status "+n.status,{timeOut:0})}).finally(function(){n.currentContractRecent="";e.gotoOa=""})}function s(n){var t=String.fromCharCode(65+n%26),i=parseInt(n/26,10);return i>0?s(i-1)+t:t}function y(i){return t.all([n.getMaterialDetails(i),n.getMaterialPlants(i),n.getMaterialUoms(i)]).then(function(r){var f,u,e;return r[0].data?(u=[],e=[],_.forEach(r[1].data,function(t){u=u.concat(_.where(n.fixedVal.sites,{plant:t}))}),_.sortBy(u,"site"),_.forEach(r[2].data,function(t){e.push({uom:_.find(n.fixedVal.uom,{value:t.UOM})||{value:t.UOM,text:t.UOM},baseAmt:t.Numerator,altAmt:t.Denominator})}),f={value:i,MMDesc:r[0].data.MMDesc,SlSupplierPartNum:r[0].data.SlSupplierPartNum,SlSupplierName:r[0].data.SlSupplierName,SlInd:r[0].data.SlInd,SupItemSubcategoryNm:r[0].data.SupItemSubcategoryNm,ElectricityUsageInd:r[0].data.ElectricityUsageInd,MMBaseUom:r[0].data.MMBaseUom,Sites:u,Uoms:e}):f={value:i,MMDesc:"",SlSupplierPartNum:"",SlSupplierName:"",SlInd:"",SupItemSubcategoryNm:"",ElectricityUsageInd:"",MMBaseUom:"",Sites:[],Uoms:[]},t.when(f)})}function p(t,i){var r=!1;_.forEach(t,function(t){var u,i;_.forEach(n.fixedVal.oaXlsx,function(n){t[n.value]=typeof t[n.text]=="string"?t[n.text].trim():t[n.text]||""});u=_.find(n.contract.Lines,{ItemNo:parseInt(t.ItemNo,10)});i=!u?{NewLine:!0,BadSites:[],OriginalSites:[],Sites:[],SiteString:""}:u;u||(i.ItemNo=h(),n.contract.Lines.push(i));i.Selected=!0;i.Warnings=[];i.Contract=n.contract.Contract;(t.Contract||"").toString().trim()!==(n.contract.Contract||"").toString().trim()&&i.Warnings.push("OA Number does not match. Please double-check data.");!t.ItemNo||u||i.Warnings.push("Line Number does not exist in this OA. Please double-check data. This line has been assigned the next available number. Line Number should be left blank for a new line.");t.DeleteInd?t.DeleteInd.toString().trim().toUpperCase()==="X"?(i.DeleteInd!=="X"&&n.contract.PurchOrg==="S044"&&i.Warnings.push("Please ensure you have given a reason for deletion in the comments, along with the replacement contract and line if available."),i.DeleteInd="X"):i.NewLine?(i.Warnings.push("Deletion indicator is invalid (must be X). Line not deleted."),i.DeleteInd=""):i.Warnings.push("Deletion indicator is invalid (must be X). Existing status kept."):i.DeleteInd="";i.ShortText=!t.ShortText?"":t.ShortText.toString().trim();i.SIActive=_.find(n.fixedVal.preferredStatus,{value:t.SIActive.toString().trim().toUpperCase()})||_.find(n.fixedVal.preferredStatus,function(n){return n.text.toUpperCase()===t.SIActive.toString().trim().toUpperCase()})||(!t.SIActive.toString().trim()?"":{value:t.SIActive.toString().trim().toUpperCase(),text:t.SIActive.toString().trim().toUpperCase()});i.SICMApproval=_.find(n.fixedVal.cmStatus,{value:t.SICMApproval.toString().trim().toUpperCase()})||_.find(n.fixedVal.cmStatus,function(n){return n.text.toUpperCase()===t.SICMApproval.toString().trim().toUpperCase()})||(!t.SICMApproval.toString().trim()?"":{value:t.SICMApproval.toString().trim().toUpperCase(),text:t.SICMApproval.toString().trim().toUpperCase()});i.SISiteApproval=_.find(n.fixedVal.siteStatus,{value:t.SISiteApproval.toString().trim().toUpperCase()})||_.find(n.fixedVal.siteStatus,function(n){return n.text.toUpperCase()===t.SISiteApproval.toString().trim().toUpperCase()})||(!t.SISiteApproval.toString().trim()?"":{value:t.SISiteApproval.toString().trim().toUpperCase(),text:t.SISiteApproval.toString().trim().toUpperCase()});i.SITDApproval=_.find(n.fixedVal.tdStatus,{value:t.SITDApproval.toString().trim().toUpperCase()})||_.find(n.fixedVal.tdStatus,function(n){return n.text.toUpperCase()===t.SITDApproval.toString().trim().toUpperCase()})||(!t.SITDApproval.toString().trim()?"":{value:t.SITDApproval.toString().trim().toUpperCase(),text:t.SITDApproval.toString().trim().toUpperCase()});e.updateApproveStatus(i);i.ConditionStart=t.ConditionStart?typeof t.ConditionStart=="string"?moment(t.ConditionStart).isValid()?moment(t.ConditionStart).format("YYYY-MM-DD"):"":typeof t.ConditionStart=="number"?o(t.ConditionStart)==="Invalid date"?"":o(t.ConditionStart):"":moment().format("MM/DD/YYYY");i.ConditionEnd=t.ConditionEnd?typeof t.ConditionEnd=="string"?moment(t.ConditionEnd).isValid()?moment(t.ConditionEnd).format("YYYY-MM-DD"):"":typeof t.ConditionStart=="number"?o(t.ConditionEnd)==="Invalid date"?"":o(t.ConditionEnd):"":"12/31/9999";(i.QuoteDIR&&i.QuoteDIR.toString().trim().toUpperCase())!==t.QuoteDIR.toString().trim().toUpperCase()&&(i.QuoteDIR=!t.QuoteDIR?"":t.QuoteDIR.toString().trim(),i.ReferencedQuote="");i.VendMat=!t.VendMat?"":t.VendMat.toString().trim();i.PlanDel=!t.PlanDel?"":t.PlanDel.toString().trim();i.NetPrice=!t.NetPrice?"":t.NetPrice.toString().trim();i.Incoterms1=_.find(n.fixedVal.incoTerms,{value:t.Incoterms1.toString().trim().toUpperCase()})||_.find(n.fixedVal.incoTerms,function(n){return n.text.toUpperCase()===t.Incoterms1.toString().trim().toUpperCase()})||{value:t.Incoterms1.toString().trim().toUpperCase(),text:t.Incoterms1.toString().trim().toUpperCase()};i.Incoterms2=!t.Incoterms2?i.Incoterms1.inco2||"":t.Incoterms2.toString().trim();i.Shipping=_.find(n.fixedVal.shipInst,{value:t.Shipping.toString().trim().toUpperCase()})||_.find(n.fixedVal.shipInst,function(n){return n.text.toUpperCase()===t.Shipping.toString().trim().toUpperCase()})||!!t.Shipping.toString().trim().toUpperCase()?{value:t.Shipping.toString().trim().toUpperCase(),text:t.Shipping.toString().trim().toUpperCase()}:i.NewLine?_.find(n.fixedVal.shipInst,{"default":"true"}):"";i.SIMfrnr=!t.SIMfrnr?"":t.SIMfrnr.toString().trim();i.SIMfrpn=!t.SIMfrpn?"":t.SIMfrpn.toString().trim();i.SISupplierDiffJustif=typeof t.SISupplierDiffJustif=="string"?_.find(n.fixedVal.supplierDifference,function(n){return n.toUpperCase()===t.SISupplierDiffJustif.toString().trim().toUpperCase()})||t.SISupplierDiffJustif.toString().trim()||"":typeof t.SISupplierDiffJustif=="number"?n.fixedVal.supplierDifference[t.SISupplierDiffJustif]||"Invalid":"Invalid";i.SIModelDiffJustif=typeof t.SIModelDiffJustif=="string"?_.find(n.fixedVal.supplierDifference,function(n){return n.toUpperCase()===t.SIModelDiffJustif.toString().trim().toUpperCase()})||t.SIModelDiffJustif.toString().trim()||"":typeof t.SIModelDiffJustif=="number"?n.fixedVal.supplierDifference[t.SIModelDiffJustif]||"Invalid":"Invalid";i.SISupplierDiffComment=!t.SISupplierDiffComment?"":t.SISupplierDiffComment.toString().trim();i.SIModelDiffComment=!t.SIModelDiffComment?"":t.SIModelDiffComment.toString().trim();i.SIFcstLt=!t.SIFcstLt?i.PlanDel||"":t.SIFcstLt.toString().trim();i.SIFcstNotice=!t.SIFcstNotice?"":t.SIFcstNotice.toString().trim();i.SIITMRequotingTime=!t.SIITMRequotingTime?"":t.SIITMRequotingTime.toString().trim();n.contract.PurchOrg!=="S044"||i.SIITMRequotingTime||(i.SIITMRequotingTime="7");i.SICeMarking=_.find(n.fixedVal.ceMarking,{value:t.SICeMarking.toString().trim().toUpperCase()})||_.find(n.fixedVal.ceMarking,function(n){return n.text.toUpperCase()===t.SICeMarking.toString().trim().toUpperCase()})||{value:t.SICeMarking.toString().trim().toUpperCase(),text:t.SICeMarking.toString().trim().toUpperCase()};i.SIMinOrderQty=!t.SIMinOrderQty?"":t.SIMinOrderQty.toString().trim();i.NoteLongText=!t.NoteLongText?"":t.NoteLongText.toString().trim();i.AllSites=_.clone(_.where(n.fixedVal.sites,{parentPOrg:n.contract.PurchOrg}).length>0?_.where(n.fixedVal.sites,{parentPOrg:n.contract.PurchOrg}):_.where(n.fixedVal.sites,{pOrg:n.contract.PurchOrg}),!0);_.forEach(i.AllSites,function(i){i.ShippingCondition=_.find(n.fixedVal.shipCond,{"default":"true"})||{value:"",text:"",transitTime:""};i.Selected=!1;!t[i.site]||!t[i.site].toString().trim()||(i.ShippingCondition=_.find(n.fixedVal.shipCond,{value:t[i.site].toString().trim().toUpperCase()})||_.find(n.fixedVal.shipCond,function(n){return n.text.toUpperCase()===t[i.site].toString().trim().toUpperCase()})||{value:t[i.site].toString().trim().toUpperCase()},i.Selected=!0)});i.SiteString=_.pluck(_.sortBy(_.where(i.AllSites.concat(i.BadSites),{Selected:!0}),"site"),"site").join(", ");i.NewLine?(i.Material={value:t.Material||""},!i.Material.value||e.updateMaterial(i,!1,!0)):i.Material.value.toString().trim()!==t.Material.toString().trim()&&i.Warnings.push("MM Number cannot be changed on an existing line.");i.NewLine?i.OrderprUn={uom:_.find(n.fixedVal.uom,{value:t.OrderprUn.toString().trim().toUpperCase()})||_.find(n.fixedVal.uom,function(n){return n.text.toUpperCase()===t.OrderprUn.toString().trim().toUpperCase()})||{value:t.OrderprUn.toString().trim().toUpperCase()||""}}:i.OrderprUn.uom.value.toString().trim()!==t.OrderprUn.toString().trim()&&i.Warnings.push("Unit of Measure cannot be changed on an existing line.");i.Warnings.length>0&&(i.Selected=!1,r=!0)});toastr.clear();r?toastr.warning("Please check the data before saving.",i+" imported with some issues.",{timeOut:0}):toastr.success("",i+" imported successfully!",{timeOut:8e3})}function h(){for(var i=_.max(n.contract.Lines,function(n){return n.ItemNo}),r=parseInt(i.ItemNo,10)+1,t=r;;t++)if(t%parseInt(n.fixedVal.defaults.lineIncrement,10)==0)return t}function w(n){for(var i=new ArrayBuffer(n.length),r=new Uint8Array(i),t=0;t!=n.length;++t)r[t]=n.charCodeAt(t)&255;return i}function c(i,r){var f,u,o,s;return r||(r=[]),i?(f=t.defer(),r.push(f.promise),u=[],i.errors=[],i.NewLine&&i.DeleteInd==="X"&&i.errors.push("A new line cannot be deleted. Uncheck the line to skip saving it."),i.ShortText||i.errors.push("Line Description is required."),i.ShortText&&!n.validChars.test(i.ShortText.toString().trim())&&i.errors.push("Line Description has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),i.ShortText&&i.ShortText.toString().trim().length>40&&i.errors.push("Line Description is over 40 characters."),_.find(n.fixedVal.preferredStatus,{value:i.SIActive&&i.SIActive.value})||i.errors.push("Preferred Status is invalid."),_.find(n.fixedVal.cmStatus,{value:i.SICMApproval&&i.SICMApproval.value})||!i.SICMApproval||!i.SICMApproval.value||i.errors.push("CM Approval is invalid."),_.find(n.fixedVal.siteStatus,{value:i.SISiteApproval&&i.SISiteApproval.value})||!i.SISiteApproval||!i.SISiteApproval.value||i.errors.push("Site Approval is invalid."),_.find(n.fixedVal.tdStatus,{value:i.SITDApproval&&i.SITDApproval.value})||!i.SITDApproval||!i.SITDApproval.value||i.errors.push("TD Approval is invalid."),e.updateApproveStatus(i),i.ConditionStart&&moment(i.ConditionStart).isValid()||i.errors.push("Line Start Date is invalid."),i.ConditionEnd&&moment(i.ConditionEnd).isValid()||i.errors.push("Line End Date is invalid."),moment(i.ConditionStart).isValid()&&moment(i.ConditionEnd).isValid()&&moment(i.ConditionEnd).isBefore(moment(i.ConditionStart),"day")&&i.errors.push("Line Start Date cannot be after End Date."),i.NewLine&&i.ConditionStart&&moment(i.ConditionStart).isValid()&&i.ConditionEnd&&moment(i.ConditionEnd).isValid()&&(moment(i.ConditionEnd).isBefore(moment(),"day")||moment(i.ConditionStart).isAfter(moment(),"day"))&&i.errors.push("Line Dates must be valid as of today for a new line."),i.QuoteDIR?(o=t.defer(),u.push(o.promise),e.getDocument(i).then(function(n){n.datesOverwritten&&i.errors.push("Line start/end dates have been overwritten from the Quote Document.")},function(){i.QuoteDIR="";i.ReferencedQuote="";i.errors.push("Quote document does not exist.")}).finally(function(){o.resolve()})):(i.QuoteDIR="",i.ReferencedQuote=""),i.VendMat&&i.VendMat.toString().trim().length>35&&i.errors.push("Supplier Part Number is over 35 characters."),i.PlanDel||i.errors.push("Unfcst LT is required."),i.PlanDel&&!/^\d{1,3}$/.test(i.PlanDel.toString().trim())&&i.errors.push("Unfcst LT must be a number between 0 and 999."),i.NetPrice&&i.NetPrice!==0&&i.NetPrice!==""&&i.NetPrice!=="0"?(i.NetPrice=i.NetPrice&&i.NetPrice.toString().replace(/[\$,]/g,""),/^\d*\.?\d*$/.test(i.NetPrice)||i.errors.push("Price is invalid. It must contain only numbers and a decimal.")):i.errors.push("Price cannot be left blank and must be greater than 0."),_.find(n.fixedVal.incoTerms,{value:i.Incoterms1&&i.Incoterms1.value})||!i.Incoterms1||!i.Incoterms1.value||i.errors.push("IncoTerms are invalid."),i.Incoterms2&&!n.validChars.test(i.Incoterms2.toString().trim())&&i.errors.push("IncoTerms Location has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),i.Incoterms2&&i.Incoterms2.toString().trim().length>28&&i.errors.push("IncoTerms Location is over 28 characters."),_.find(n.fixedVal.shipInst,{value:i.Shipping&&i.Shipping.value})||!i.Shipping||!i.Shipping.value||i.errors.push("Shipping Instructions are invalid."),i.SIMfrnr&&!n.validChars.test(i.SIMfrnr.toString().trim())&&i.errors.push("Manufacturer Name has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),i.SIMfrnr&&i.SIMfrnr.toString().trim().length>35&&i.errors.push("Manufacturer Name is over 35 characters."),i.SIMfrpn&&!n.validChars.test(i.SIMfrpn.toString().trim())&&i.errors.push("Manufacturer Part Number has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),i.SIMfrpn&&i.SIMfrpn.toString().trim().length>35&&i.errors.push("Manufacturer Part Number is over 35 characters."),_.contains(n.fixedVal.supplierDifference,i.SISupplierDiffJustif)||!i.SISupplierDiffJustif||i.errors.push("Supplier Difference Justification is invalid."),_.contains(n.fixedVal.modelDifference,i.SIModelDiffJustif)||!i.SIModelDiffJustif||i.errors.push("Model Difference Justification is invalid."),i.SISupplierDiffComment&&!n.validChars.test(i.SISupplierDiffComment.toString().trim())&&i.errors.push("Supplier Diff Justification Comment has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),i.SISupplierDiffComment&&i.SISupplierDiffComment.toString().trim().length>255&&i.errors.push("Supplier Diff Justification Comment is over 255 characters."),i.SIModelDiffComment&&!n.validChars.test(i.SIModelDiffComment.toString().trim())&&i.errors.push("Model Diff Justification Comment has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),i.SIModelDiffComment&&i.SIModelDiffComment.toString().trim().length>255&&i.errors.push("Model Diff Justification Comment is over 255 characters."),i.SIFcstLt&&!/^\d{1,3}$/.test(i.SIFcstLt.toString().trim())&&i.errors.push("Forecast LT must be a number between 0 and 999."),i.SIFcstNotice&&!/^\d{1,3}$/.test(i.SIFcstNotice.toString().trim())&&i.errors.push("Forecast Notice must be a number between 0 and 999."),_.find(n.fixedVal.ceMarking,{value:i.SICeMarking&&i.SICeMarking.value})||!i.SICeMarking||!i.SICeMarking.value||i.errors.push("CE Marking is invalid."),!i.SIMinOrderQty||/^\d{0,9}\.?(\.\d{0,3})?$/.test(i.SIMinOrderQty.toString().trim())||i.errors.push("Minimum Order Qty is invalid. Must be numeric and can have up to 3 decimal places."),i.NoteLongText&&i.NoteLongText.toString().trim().length>16e3&&i.errors.push("The comment is over 16000 characters. Surely you can be more concise than that! ;-)"),_.forEach(_.where(i.AllSites,{Selected:!0}),function(t){_.find(n.fixedVal.shipCond,{value:t.ShippingCondition&&t.ShippingCondition.value})||!t.ShippingCondition&&!t.ShippingCondition.value||i.errors.push(t.site+" Shipping Condition is invalid.")}),i.Material&&i.Material.value&&!/^\d{1,10}$/.test(i.Material.value.toString().trim())?i.errors.push("MM Number must be numeric with a maximum length of 10."):i.Material.value?(s=t.defer(),u.push(s.promise),e.updateMaterial(i,!1,!0).then(function(n){n.Material.MMDesc||i.errors.push("Material is not valid.");_.find(n.Material.Uoms,function(t){return t.uom.value===(n.OrderprUn&&n.OrderprUn.uom&&n.OrderprUn.uom.value)})||i.errors.push("Unit of Measure is invalid for this Material.")}).finally(function(){s.resolve()})):_.find(n.fixedVal.uom,{value:i.OrderprUn&&i.OrderprUn.uom&&i.OrderprUn.uom.value})||i.errors.push("Unit of Measure is invalid."),t.all(u).then(function(){}).finally(function(){f.resolve()}),i.VendMat||i.errors.push("Supplier Part Number is required."),i.SIMfrnr||i.errors.push("Manufacturer Name is required."),i.SIMfrpn||i.errors.push("Manufacturer Part Number is required."),n.contract.PurchOrg=="S044"&&(i.Material.SlInd&&i.Material.SlInd.toString().trim()==="1"&&!i.SISupplierDiffJustif&&i.Material.SlSupplierName&&i.SIMfrnr.toString().trim().toUpperCase()!==i.Material.SlSupplierName.toString().trim().toUpperCase()&&i.errors.push("Supplier Difference Justification is required if Manufacturer Name is different than the MM Supplier Name for SL 1."),i.Material.SlInd&&(i.Material.SlInd.toString().trim()==="1"||i.Material.SlInd.toString().trim()==="2")&&!i.SIModelDiffJustif&&i.Material.SlSupplierPartNum&&i.SIMfrpn.toString().trim().toUpperCase()!==i.Material.SlSupplierPartNum.toString().trim().toUpperCase()&&i.errors.push("Model Difference Justification is required if Manufacturer Part Number is different than the MM Supplier Part Number for SL 1 or 2."),i.SISupplierDiffJustif!==_.last(n.fixedVal.supplierDifference)||i.SISupplierDiffComment||i.errors.push('Supplier Diff Justification Comment is required when "Other" is selected in the justification.'),i.SIModelDiffJustif!==_.last(n.fixedVal.modelDifference)||i.SIModelDiffComment||i.errors.push('Model Diff Justification Comment is required when "Other" is selected in the justification.'),i.SIFcstNotice&&i.SIFcstNotice!=="0"||i.PlanDel.toString().trim()===i.SIFcstLt.toString().trim()||i.errors.push("Forecast Notice is required if Forecasted LT does not equal Unforecasted LT."),i.SIITMRequotingTime&&i.SIITMRequotingTime!=="0"&&/^\d{1,3}$/.test(i.SIITMRequotingTime.toString().trim())||i.errors.push("Expiration Notice must be a number between 1 and 999."),_.any(i.AllSites,{Selected:!0})||i.errors.push("At least one site must be selected."))):(n.contract.errors=[],_.find(n.fixedVal.oaType,{value:n.contract.DocType})||n.contract.errors.push("OA Type is invalid."),_.find(n.fixedVal.purchOrg,{value:n.contract.PurchOrg})||n.contract.errors.push("POrg is invalid."),n.contract.Vendor&&/^\d{10}$/.test(n.contract.Vendor.toString().trim())||n.contract.errors.push("Supplier ID must be a 10-digit number."),_.find(n.fixedVal.currency,{value:n.contract.Currency&&n.contract.Currency.value})||n.contract.errors.push("Currency is invalid."),n.contract.VperStart&&moment(n.contract.VperStart).isValid()||n.contract.errors.push("Header Start Date is invalid."),n.contract.VperEnd&&moment(n.contract.VperEnd).isValid()||n.contract.errors.push("Header End Date is invalid."),moment(n.contract.VperStart).isValid()&&moment(n.contract.VperEnd).isValid()&&moment(n.contract.VperEnd).isBefore(moment(n.contract.VperStart),"day")&&n.contract.errors.push("Header Start Date cannot be after End Date."),n.contract.newContract&&n.contract.VperStart&&moment(n.contract.VperStart).isValid()&&n.contract.VperEnd&&moment(n.contract.VperEnd).isValid()&&(moment(n.contract.VperEnd).isBefore(moment(),"day")||moment(n.contract.VperStart).isAfter(moment(),"day"))&&n.contract.errors.push("Header Dates must be valid as of today for a new contract."),n.contract.ReferencedContract&&!n.validChars.test(n.contract.ReferencedContract.toString().trim())&&n.contract.errors.push("Contract Number has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),n.contract.ReferencedContract&&n.contract.ReferencedContract.toString().trim().length>132&&n.contract.errors.push("Contract Number is over 132 characters."),n.contract.PurGroup&&_.find(n.purGroup,{value:n.contract.PurGroup&&n.contract.PurGroup.value})||n.contract.errors.push("CM is invalid."),n.contract.HdrBuyerField&&_.find(n.purGroup,{value:n.contract.HdrBuyerField&&n.contract.HdrBuyerField.value})||n.contract.errors.push("CCM is invalid."),_.find(n.fixedVal.incoTerms,{value:n.contract.Incoterms1&&n.contract.Incoterms1.value})||n.contract.errors.push("IncoTerms are invalid."),n.contract.Incoterms2&&!n.validChars.test(n.contract.Incoterms2.toString().trim())&&n.contract.errors.push("IncoTerms Location has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),n.contract.Incoterms2&&n.contract.Incoterms2.toString().trim().length>28&&n.contract.errors.push("IncoTerms Location is over 28 characters."),_.find(n.fixedVal.paymentTerms,{value:n.contract.Pmnttrms&&n.contract.Pmnttrms.value})||n.contract.errors.push("Payment Terms are invalid."),n.contract.SalesPers&&!n.validChars.test(n.contract.SalesPers.toString().trim())&&n.contract.errors.push("Supplier Contact has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),n.contract.SalesPers&&n.contract.SalesPers.toString().trim().length>30&&n.contract.errors.push("Supplier Contact is over 30 characters."),n.contract.Telephone&&!n.validChars.test(n.contract.Telephone.toString().trim())&&n.contract.errors.push("Supplier Telephone has invalid characters. Only alphanumeric, space, and !\"%&'()*+,-./:;<=>?_ are valid."),n.contract.Telephone&&n.contract.Telephone.toString().trim().length>16&&n.contract.errors.push("Supplier Telephone is over 16 characters."),n.contract.DocType!=="ZCON"||n.contract.PurchOrg!=="S044"||n.contract.ReferencedContract||n.contract.errors.push("Contract Number is required."),_.contains(n.fixedVal.sirfisForecast,n.contract.HdrSirfisFcst)||n.contract.errors.push("SIRFIS Indicator is invalid."),_.forEach(n.contract.Lines,function(n){c(n,r)})),r}var e=this;return e.data=n,e.processing=!1,e.validating=!1,e.uoms=[],_.forEach(n.fixedVal.uom,function(n){e.uoms.push({uom:n})}),e.rABS=typeof FileReader!="undefined"&&typeof FileReader.prototype!="undefined"&&typeof FileReader.prototype.readAsBinaryString!="undefined",e.activateContractLine=function(t){n.activeContractLine=t;e.updateMaterial(t);e.getDocument(t)},e.cancelOa=function(){n.contractReady=!1;n.editContract=!1;n.contractCheckAll=!1;n.contract={};toastr.clear();toastr.info("","OA canceled")},e.changeChecked=function(){var t;if(n.contractCheckAll)for(t=0;t<n.filteredContractLines.length;t++)n.filteredContractLines[t].Selected=!0;else for(t=0;t<n.contract.Lines.length;t++)n.contract.Lines[t].Selected=!1},e.changeContract=function(t,i){!t||(n.contractReady=!1,n.editContract=!1,n.contractFilter={},toastr.clear(),toastr.info("","Retrieving OA "+t,{timeOut:0}),l(t,i))},e.changeLine=function(t){var i=_.findIndex(n.contract.Lines,{ItemNo:n.activeContractLine.ItemNo});t===!1?(i=i===0?n.contract.Lines.length-1:i-1,!n.contract.Lines[i]||e.activateContractLine(n.contract.Lines[i])):t===!0?(i=i===n.contract.Lines.length-1?0:i+1,!n.contract.Lines[i]||e.activateContractLine(n.contract.Lines[i])):_.isNumber(parseInt(t,10))&&!_.isNaN(parseInt(t,10))&&(i=_.findIndex(n.contract.Lines,{ItemNo:parseInt(t,10)}),!n.contract.Lines[i]||e.activateContractLine(n.contract.Lines[i]));e.gotoLine=""},e.changePorg=function(){_.forEach(n.contract.Lines,function(t){t.AllSites=_.clone(_.where(n.fixedVal.sites,{parentPOrg:n.contract.PurchOrg}).length>0?_.where(n.fixedVal.sites,{parentPOrg:n.contract.PurchOrg}):_.where(n.fixedVal.sites,{pOrg:n.contract.PurchOrg}),!0);t.SiteString="";_.forEach(t.AllSites,function(t){t.ShippingCondition=_.find(n.fixedVal.shipCond,{"default":"true"})||{value:"",text:"",transitTime:""}})});n.contract.PurchOrg==="S044"&&_.forEach(n.contract.Lines,function(n){n.SIITMRequotingTime&&n.SIITMRequotingTime!=="0"||(n.SIITMRequotingTime="7")})},e.cleanPrice=function(n){!n.NetPrice||(n.NetPrice=n.NetPrice.toString().replace(/[^\d.]/g,""))},e.closeAlert=function(){n.activeContractLine.Errors.length=0},e.commentsRequired=function(t,i){return n.contract.PurchOrg==="S044"&&t===_.last(i)?!0:!1},e.deleteLine=function(t){n.contract.PurchOrg==="S044"&&t.DeleteInd==="X"&&toastr.warning("Please ensure you have given a reason for deletion in the comments, along with the replacement contract and line if available.","Line "+t.ItemNo+" deleted",{timeOut:0})},e.discardChanges=function(){n.contractReady=!1;n.editContract=!1;toastr.clear();toastr.info("","Re-pulling OA "+n.contract.Contract);l(n.contract.Contract)},e.download=function(){var t={},o=n.fixedVal.oaXlsx,h=_.sortBy(_.where(n.fixedVal.sites,{parentPOrg:n.contract.PurchOrg}).length>0?_.where(n.fixedVal.sites,{parentPOrg:n.contract.PurchOrg}):_.where(n.fixedVal.sites,{pOrg:n.contract.PurchOrg}),"site"),e;t.SheetNames=[];t.SheetNames[0]=n.contract.Contract;t.Sheets={};t.Sheets[t.SheetNames[0]]={};var u=t.Sheets[t.SheetNames[0]],f=0,i="";_.forEach(o,function(t){if(t.value==="Sites")_.forEach(h,function(t){i=s(f);u[i+"1"]={v:t.site,t:"s",z:"General"};_.forEach(n.filteredContractLines,function(n,r){u[i+(r+2)]={v:!_.find(n.Sites,{site:t.site})?"":_.find(n.Sites,{site:t.site}).ShippingCondition.value,t:"s",z:"General"}});f++});else{i=s(f);u[i+"1"]={v:t.text,t:"s",z:"General"};var e;_.forEach(n.filteredContractLines,function(n,f){e={t:t.type,z:t.z};e.v=t.filter?r(t.filter)(n[t.value]):(typeof n[t.value]=="object"?n[t.value].value:n[t.value])||"";u[i+(f+2)]=e});f++}});u["!ref"]="A1:"+s(f-1)+(n.filteredContractLines.length+1);e=XLSX.write(t,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([w(e)],{type:""}),"OA "+n.contract.Contract+".xlsx");n.filteredContractLines.length<n.contract.Lines.length&&(toastr.clear(),toastr.info("","This data is currently filtered. Only the filtered lines have been downloaded.",{timeOut:5e3}))},e.drop=function(n){var r=t.defer(),i=new FileReader;return i.onload=function(t){var i,u,f,o;i=t.target.result;u=e.rABS?XLSX.read(i,{cellNF:!0,cellStyles:!0,type:"binary"}):XLSX.read(v(i),{cellNF:!0,cellStyles:!0,type:"base64"});f=u.SheetNames[0];o=XLSX.utils.sheet_to_json(u.Sheets[f],{raw:!0});p(o,n[0].name);r.resolve()},n.length===1?n[0].type==="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"?(toastr.clear(),toastr.info("","Importing "+n[0].name,{timeOut:0}),e.rABS?i.readAsBinaryString(n[0]):i.readAsArrayBuffer(n[0])):(toastr.clear(),toastr.error("","Only XLSX files can be uploaded.",{timeOut:0})):(toastr.clear(),toastr.error("","Please select only one file.",{timeOut:0})),r.promise},e.editContract=function(){n.contractUnchanged=_.clone(n.contract,!0);n.editContract=!0},e.firstHalf=function(n,t){return n+1<=Math.ceil(t/2)},e.getAltUomText=function(n,t){return!t||!t.MMBaseUom?"":n.uom.value===t.MMBaseUom?"[Base UOM]":"["+(n.altAmt&&n.altAmt.toString()!=="1"?uom.altAmt.toString()+" "+n.uom.value+" = ":"")+(n.baseAmt&&n.baseAmt.toString())+" "+t.MMBaseUom+"]"},e.getDocument=function(i,r,u){return i.datesOverwritten=!1,i.QuoteDIR?n.getDocument(i.QuoteDIR).then(function(u){return i.ReferencedQuote=u.data.Description,n.editContract&&(moment(u.data.QuoteValidFrom).isSame(moment(i.ConditionStart),"day")&&moment(u.data.QuoteValidTo).isSame(moment(i.ConditionEnd),"day")||(i.ConditionStart=u.data.QuoteValidFrom,i.ConditionEnd=u.data.QuoteValidTo,i.datesOverwritten=!0,r&&toastr.warning("Line start/end dates have been overwritten from the Quote Document","Line "+i.ItemNo,{timeOut:6e3}))),t.when(i)},function(){return i.ReferencedQuote="",u&&(toastr.warning("","Quote "+i.QuoteDIR+" does not exist"),i.QuoteDIR=""),t.reject(i)}).finally(function(){e.updateApproveStatus(i)}):(i.ReferencedQuote="",e.updateApproveStatus(i),t.when(i))},e.getSortClass=function(t){return n.contractOrderByField!==t?"fa-sort":n.contractReverseSort?"fa-sort-amount-desc":"fa-sort-amount-asc"},e.newContract=function(t){n.contractCheckAll=!1;t?(n.contract=t,n.contract.Contract="",n.contract.errors=null,_.forEach(n.contract.Lines,function(n){n.NewLine=!0;n.errors=null;n.OriginalSites=[];n.BadSites=[];n.Sites=[];var t=_.where(n.AllSites,{Selected:!0});t=_.sortBy(t,"site");n.SiteString=_.pluck(t,"site").join(", ")})):(n.contract={},n.contract.Contract="",n.contract.HdrSirfisFcst="N/A",n.contract.Lines=[{Selected:!0,NewLine:!0,ItemNo:parseInt(n.fixedVal.defaults.lineIncrement,10),DeleteInd:"",Acctasscat:"",Material:{value:""},SIActive:"",SIStatus:_.find(n.fixedVal.approveStatus,{value:"A"}),SICMApproval:"",SISiteApproval:"",SITDApproval:"",ConditionStart:moment().format("MM/DD/YYYY"),ConditionEnd:"12/31/9999",ShortText:"",MatlGroup:"",ReferencedQuote:"",VendMat:"",PlanDel:"",NetPrice:"",OrderprUn:"",Incoterms1:"",Incoterms2:"",Shipping:_.find(n.fixedVal.shipInst,{"default":"true"}),SIMfrnr:"",SIMfrpn:"",SISupplierDiffJustif:"",SIModelDiffJustif:"",SISupplierDiffComment:"",SIModelDiffComment:"",SIFcstLt:"",SIFcstNotice:"",SIITMRequotingTime:n.contract.PurchOrg==="S044"?"7":"",SICeMarking:"",SIMinOrderQty:"",AllSites:[],BadSites:[],OriginalSites:[],Sites:[],SiteString:""}]);n.editContract=!0;n.contractReady=!0;n.contract.newContract=!0;e.activateContractLine(_.first(n.contract.Lines))},e.newLine=function(t){var i={},r;t?(i=_.clone(t,!0),i.Selected=!0,i.NewLine=!0,i.errors=null,i.ItemNo=h(),i.BadSites=[],i.OriginalSites=[],i.SIActive=t.SIActive,i.SICMApproval=t.SICMApproval,i.SISiteApproval=t.SISiteApproval,i.SITDApproval=t.SITDApproval,i.Material=_.clone(t.Material,!0),i.OrderprUn=t.OrderprUn,i.Incoterms1=t.Incoterms1,i.Shipping=t.Shipping,i.SICeMarking=t.SICeMarking,_.forEach(i.AllSites,function(t){t.ShippingCondition=_.find(n.fixedVal.shipCond,{value:t.ShippingCondition.value})}),r=_.where(i.AllSites,{Selected:!0}),r=_.sortBy(r,"site"),i.SiteString=_.pluck(r,"site").join(", ")):(i={Selected:!0,NewLine:!0,ItemNo:h(),DeleteInd:"",Acctasscat:"",Material:"",SIActive:"",SIStatus:"",SICMApproval:"",SISiteApproval:"",SITDApproval:"",ConditionStart:moment().format("MM/DD/YYYY"),ConditionEnd:"12/31/9999",ShortText:"",MatlGroup:"",ReferencedQuote:"",VendMat:"",PlanDel:"",NetPrice:"",OrderprUn:"",Incoterms1:"",Incoterms2:"",Shipping:_.find(n.fixedVal.shipInst,{"default":"true"}),SIMfrnr:"",SIMfrpn:"",SISupplierDiffJustif:"",SIModelDiffJustif:"",SISupplierDiffComment:"",SIModelDiffComment:"",SIFcstLt:"",SIFcstNotice:"",SIITMRequotingTime:n.contract.PurchOrg==="S044"?"7":"",SICeMarking:"",SIMinOrderQty:"",AllSites:_.clone(_.where(n.fixedVal.sites,{parentPOrg:n.contract.PurchOrg}).length>0?_.where(n.fixedVal.sites,{parentPOrg:n.contract.PurchOrg}):_.where(n.fixedVal.sites,{pOrg:n.contract.PurchOrg}),!0),BadSites:[],OriginalSites:[],Sites:[],SiteString:""},_.forEach(i.AllSites,function(t){t.ShippingCondition=_.find(n.fixedVal.shipCond,{"default":"true"})||{value:"",text:"",transitTime:""}}));e.updateApproveStatus(i);n.contract.Lines.push(i);e.activateContractLine(_.last(n.contract.Lines))},e.populateDescription=function(n){n.ShortText||(n.ShortText=n.Material.MMDesc||"")},e.populateForecastLt=function(n){n.SIFcstLt||(n.SIFcstLt=n.PlanDel||"")},e.populateHeaderDates=function(){n.contract.DocType==="ZQUO"&&(n.contract.VperStart?null:n.contract.VperStart=moment().format("MM/DD/YYYY"),n.contract.VperEnd?null:n.contract.VperEnd="12/31/9999")},e.populateInco2=function(n){n.Incoterms2=!n.Incoterms1||!n.Incoterms1.inco2?"":n.Incoterms1.inco2},e.populateManufName=function(n){n.SIMfrnr||(n.SIMfrnr=n.Material.SlSupplierName||"")},e.populateManufPart=function(n){n.SIMfrpn||(n.SIMfrpn=n.Material.SlSupplierPartNum?n.Material.SlSupplierPartNum:n.VendMat)},e.requiredModelJustification=function(t){return n.contract.PurchOrg==="S044"&&!!t&&!!t.Material&&t.Material.SlInd&&(t.Material.SlInd.toString().trim()==="1"||t.Material.SlInd.toString().trim()==="2")&&!t.SIModelDiffJustif&&t.Material.SlSupplierPartNum&&t.SIMfrpn.toString().trim()!==t.Material.SlSupplierPartNum.toString().trim()?!0:!1},e.requiredSuppJustification=function(t){return n.contract.PurchOrg==="S044"&&!!t&&!!t.Material&&t.Material.SlInd&&(t.Material.SlInd.toString().trim()==="1"||t.Material.SlInd.toString().trim()==="2")&&!t.SISupplierDiffJustif&&t.Material.SlSupplierName&&t.SIMfrnr.toString().trim()!==t.Material.SlSupplierName.toString().trim()?!0:!1},e.saveContract=function(){e.processing=!0;e.validating=!0;toastr.clear();toastr.info("","Validating contract...",{timeOut:0});t.all(c()).then(function(){if(e.validating=!1,n.contract.errors&&n.contract.errors.length>0)toastr.clear(),toastr.error("Please check the data.","The contract header has errors and cannot be updated.",{timeOut:0});else if(_.any(_.where(n.contract.Lines,{Selected:!0}),function(n){return n.errors&&n.errors.length>0}))toastr.clear(),toastr.error("Please check the data. You can deselect the lines with errors if you wish to save the remaining lines.","One or more selected contract lines have errors.",{timeOut:0});else{toastr.clear();toastr.info("","Saving selected contract lines...",{timeOut:0});var t={Contract:n.contract.Contract,DocType:n.contract.DocType,Vendor:n.contract.Vendor,CompCode:n.fixedVal.defaults.companyCode,VperStart:"/Date("+moment(moment(n.contract.VperStart)-moment(n.contract.VperStart).zone()*6e4).valueOf()+")/",VperEnd:"/Date("+moment(moment(n.contract.VperEnd)-moment(n.contract.VperEnd).zone()*6e4).valueOf()+")/",PurchOrg:!n.contract.PurchOrg?"":n.contract.PurchOrg,PurGroup:!n.contract.PurGroup?"":n.contract.PurGroup.PurGroup,HdrBuyerField:!n.contract.HdrBuyerField?"":n.contract.HdrBuyerField.PurGroup,HdrSirfisFcst:!n.contract.HdrSirfisFcst?"":n.contract.HdrSirfisFcst,ReferencedContract:!n.contract.ReferencedContract?"":n.contract.ReferencedContract,Incoterms1:!n.contract.Incoterms1?"":n.contract.Incoterms1.value,Incoterms2:!n.contract.Incoterms2?"":n.contract.Incoterms2,Currency:!n.contract.Currency?"":n.contract.Currency.value,SalesPers:!n.contract.SalesPers?"":n.contract.SalesPers,Telephone:!n.contract.Telephone?"":n.contract.Telephone,Pmnttrms:!n.contract.Pmnttrms?"":n.contract.Pmnttrms.value,ContractHeaderx:{Contract:"X",DocType:"X",Vendor:"X",VperStart:"X",VperEnd:"X",PurchOrg:"X",PurGroup:"X",Incoterms1:"X",Incoterms2:"X",Currency:"X",SalesPers:"X",Telephone:"X",Pmnttrms:"X"},ContractItem:[],ContractItemx:[],ContractExtension:[]},i=_.where(n.contract.Lines,{Selected:!0});_.forEach(i,function(i,u){var f;f=n.contract.newContract?(u+1)*parseInt(n.fixedVal.defaults.lineIncrement,10)+"":i.ItemNo+"";t.ContractItem[u]={};t.ContractItem[u].Contract=n.contract.Contract;t.ContractItem[u].ItemNo=f;t.ContractItem[u].DeleteInd=i.DeleteInd==="X"?"L":"";t.ContractItem[u].Acctasscat=n.fixedVal.defaults.accountAssignment;t.ContractItem[u].Material=(i.Material&&i.Material.value)+"";t.ContractItem[u].SIActive=i.SIActive&&i.SIActive.value||"";t.ContractItem[u].SIStatus=i.SIStatus&&i.SIStatus.value||"";t.ContractItem[u].SICMApproval=i.SICMApproval&&i.SICMApproval.value||"";t.ContractItem[u].SISiteApproval=i.SISiteApproval&&i.SISiteApproval.value||"";t.ContractItem[u].SITDApproval=i.SITDApproval&&i.SITDApproval.value||"";t.ContractItem[u].ConditionStart=!i.ConditionStart?"":"/Date("+moment(moment(i.ConditionStart)-moment(i.ConditionStart).zone()*6e4).valueOf()+")/";t.ContractItem[u].ConditionEnd=!i.ConditionEnd?"":"/Date("+moment(moment(i.ConditionEnd)-moment(i.ConditionEnd).zone()*6e4).valueOf()+")/";t.ContractItem[u].ShortText=i.ShortText;t.ContractItem[u].MatlGroup=n.fixedVal.defaults.materialGroup;t.ContractItem[u].QuoteDIR=i.QuoteDIR+"";t.ContractItem[u].ReferencedQuote=i.ReferencedQuote;t.ContractItem[u].VendMat=i.VendMat;t.ContractItem[u].PlanDel=i.PlanDel+"";t.ContractItem[u].NetPrice=!i.NetPrice?"0":i.NetPrice+"";t.ContractItem[u].Currency=n.contract.Currency&&n.contract.Currency.value;t.ContractItem[u].OrderprUn=i.OrderprUn&&i.OrderprUn.uom&&i.OrderprUn.uom.value||"";t.ContractItem[u].PoUnit=i.OrderprUn&&i.OrderprUn.uom&&i.OrderprUn.uom.value||"";t.ContractItem[u].Incoterms1=i.Incoterms1&&i.Incoterms1.value||"";t.ContractItem[u].Incoterms2=i.Incoterms2;t.ContractItem[u].Shipping=i.Shipping&&i.Shipping.value||"";t.ContractItem[u].SIMfrnr=i.SIMfrnr;t.ContractItem[u].SIMfrpn=i.SIMfrpn;t.ContractItem[u].SISupplierDiffJustif=i.SISupplierDiffJustif;t.ContractItem[u].SIModelDiffJustif=i.SIModelDiffJustif;t.ContractItem[u].SISupplierDiffComment=i.SISupplierDiffComment;t.ContractItem[u].SIModelDiffComment=i.SIModelDiffComment;t.ContractItem[u].SIFcstLt=i.SIFcstLt+"";t.ContractItem[u].SIFcstNotice=i.SIFcstNotice+"";t.ContractItem[u].SIITMRequotingTime=i.SIITMRequotingTime+"";t.ContractItem[u].SICeMarking=i.SICeMarking&&i.SICeMarking.value||"";t.ContractItem[u].SIMinOrderQty=!i.SIMinOrderQty?"0":i.SIMinOrderQty+"";t.ContractItem[u].NoteLongText=!i.NoteLongText?"":r("saveLongText")(i.NoteLongText);t.ContractItem[u].PriceUnit=n.fixedVal.defaults.priceUnit;t.ContractItemx[u]={};t.ContractItemx[u].ItemNo=f;t.ContractItemx[u].ItemNox="X";t.ContractItemx[u].DeleteInd="X";t.ContractItemx[u].Acctasscat="X";t.ContractItemx[u].Material="X";t.ContractItemx[u].ShortText="X";t.ContractItemx[u].MatlGroup="X";t.ContractItemx[u].VendMat="X";t.ContractItemx[u].PlanDel="X";t.ContractItemx[u].NetPrice="X";t.ContractItemx[u].OrderprUn="X";t.ContractItemx[u].PoUnit="X";t.ContractItemx[u].Incoterms1="X";t.ContractItemx[u].Incoterms2="X";t.ContractItemx[u].Shipping="X";t.ContractItemx[u].PriceUnit="X";_.forEach(i.AllSites,function(r){var u={},e;u.Contract=n.contract.Contract;u.ItemNo=f;u.Plant=r.plant;u.StgeLoc=r.sloc;u.ShippingCondition=r.ShippingCondition.value;u.DeletionInd=r.Selected?"":"X";e=_.find(i.OriginalSites,{Plant:r.plant,StgeLoc:r.sloc});!!e&&r.Selected&&(e.DeletionInd==="X"||r.ShippingCondition.value!==e.ShippingCondition.value)?t.ContractExtension.push(u):!e||r.Selected||e.DeletionInd!==""?!e&&r.Selected&&t.ContractExtension.push(u):t.ContractExtension.push(u)});_.forEach(i.BadSites,function(r){var u={},e;u.Contract=n.contract.Contract;u.ItemNo=f;u.Plant=r.plant;u.StgeLoc=r.sloc;u.ShippingCondition=r.ShippingCondition.value;u.DeletionInd=r.Selected?"":"X";e=_.find(i.OriginalSites,{Plant:r.plant,StgeLoc:r.sloc});(!e||r.Selected)&&(e||!r.Selected)||t.ContractExtension.push(u)});_.forEach(_.where(i.OriginalSites,{StgeLoc:"",DeletionInd:""}),function(i){var r={};r.Contract=n.contract.Contract;r.ItemNo=f;r.Plant=i.Plant;r.StgeLoc=i.StgeLoc;r.ShippingCondition=i.ShippingCondition.value;r.DeletionInd="X";t.ContractExtension.push(r)})});n.fetchToken().then(function(){var r={headers:{"Content-Type":"application/json","x-csrf-token":n.token}};n.updateContract(t,r).then(function(t){n.editContract=!1;_.forEach(n.contract.Lines,function(n){n.Selected&&(n.NewLine=!1)});toastr.clear();n.contract.newContract?(e.changeContract(t.data.d.Contract),toastr.success("","Contract "+n.contract.Contract+" created!")):toastr.success("","Contract "+n.contract.Contract+" saved!");i.length===0&&toastr.info("","No lines were selected. Only header data was saved.")},function(n){if(toastr.clear(),n.data.hasOwnProperty("error"))if(n.data.error.innererror.errordetails.length>0){var t=[];_.forEach(n.data.error.innererror.errordetails,function(n){n.severity==="error"&&t.push(n.message)});t=_.uniq(t);_.forEach(t,function(n){toastr.error(n,"",{timeOut:0})})}else toastr.error(n.data.error.message.value,"",{timeOut:0});else toastr.error("Error "+n.status,"An unknown error occurred.",{timeOut:0})})})}}).finally(function(){e.processing=!1})},e.scroll=function(n){u.hash(n);f()},e.selectSites=function(t){var t;if(t==="all")for(t=0;t<n.activeContractLine.AllSites.length;t++)n.activeContractLine.AllSites[t].Selected=!0;else if(t==="none")for(t=0;t<n.activeContractLine.AllSites.length;t++)n.activeContractLine.AllSites[t].Selected=!1;else if(t==="us")for(t=0;t<n.activeContractLine.AllSites.length;t++)n.activeContractLine.AllSites[t].Selected=!1,(n.activeContractLine.AllSites[t].pOrg==="1030"||n.activeContractLine.AllSites[t].pOrg==="1041")&&(n.activeContractLine.AllSites[t].Selected=!0);e.updateSiteString()},e.sort=function(t){t===n.contractOrderByField?n.contractReverseSort=!n.contractReverseSort:(n.contractOrderByField=t,n.contractReverseSort=!1)},e.updateApproveStatus=function(t){t?t.SIStatus=!t.ReferencedQuote&&n.contract.DocType==="ZQUO"||t.SICMApproval&&t.SICMApproval.value==="P"||t.SISiteApproval&&(t.SISiteApproval.value==="P"||t.SISiteApproval.value==="R")||t.SITDApproval&&(t.SITDApproval.value==="P"||t.SITDApproval.value==="R")?_.find(n.fixedVal.approveStatus,{value:"N"}):_.find(n.fixedVal.approveStatus,{value:"A"}):_.forEach(n.contract.Lines,function(n){e.updateApproveStatus(n)})},e.updateMaterial=function(n,i,r){return!n.Material||!n.Material.value?(n.Material={value:"",MMDesc:"",SlSupplierPartNum:"",SlSupplierName:"",SlInd:"",Plants:[],Uoms:[]},n.OrderprUn=_.find(e.uoms,function(t){return t.uom.value===(n.OrderprUn&&n.OrderprUn.uom&&n.OrderprUn.uom.value)}),e.populateManufPart(n),t.when(n)):y(n.Material.value).then(function(u){return n.Material=u,i&&!u.MMDesc&&toastr.warning("","Material "+n.Material.value+" is not valid."),n.OrderprUn=!n.Material.Uoms||n.Material.Uoms.length!==1||n.OrderprUn&&n.OrderprUn.uom&&_.find(n.Material.Uoms,function(t){return t.uom.value===(n.OrderprUn&&n.OrderprUn.uom&&n.OrderprUn.uom.value)})?_.find(n.Material.Uoms,function(t){return t.uom.value===(n.OrderprUn&&n.OrderprUn.uom&&n.OrderprUn.uom.value)}):n.Material.Uoms[0],r&&(e.populateDescription(n),e.populateManufName(n),e.populateManufPart(n)),t.when(n)})},e.updateSiteString=function(){var t=n.activeContractLine.AllSites.concat(n.activeContractLine.BadSites);t=_.where(t,{Selected:!0});t=_.sortBy(t,"site");n.activeContractLine.SiteString=_.pluck(t,"site").join(", ")},e.updateUoms=function(n){return!n||!n.Material||!n.Material.value?e.uoms:n.Material.Uoms},e.validate=function(n){e.validating=!0;toastr.clear();!n?toastr.info("","Validating contract...",{timeOut:0}):null;t.all(c(n)).then(function(){toastr.clear();e.validating=!1})},function(){!i.oa||!i.line||n.editContract?!i.oa||n.editContract?!!i.oa&&i.oa!==n.contract.Contract&&n.editContract&&toastr.info("Save or discard any changes first in order to retrieve a different contract.","Current contract is in edit mode.",{timeOut:0}):e.changeContract(i.oa):e.changeContract(i.oa,parseInt(i.line,10))}(),e}]);app.controller("reports",["dataService","$q",function(n){var t=this;return t.data=n,function(){}(),t}]);app.controller("search",["dataService","$q","$filter",function(n,t,i){function u(n){var t=String.fromCharCode(65+n%26),i=parseInt(n/26,10);return i>0?u(i-1)+t:t}function f(n){for(var i=new ArrayBuffer(n.length),r=new Uint8Array(i),t=0;t!=n.length;++t)r[t]=n.charCodeAt(t)&255;return i}function e(){localStorage.setItem("sombrero.search",JSON.stringify(n.search))}var r=this;return r.data=n,r.activateResultsLine=function(t){n.activeResultsLine=t},r.cleanSupplierList=function(){var t=n.search.suppliers.match(/\d+/g);t=_.uniq(t);n.search.suppliers=t.join("\n")},r.clearSearch=function(){var t=n.search;n.initializeSearch();n.search.processing=t.processing},r.clearSite=function(){n.search.site=""},r.clearFilters=function(){n.resultsFilter={}},r.clearSettings=function(){localStorage.removeItem("sombrero.search");toastr.warning("Local settings cleared")},r.download=function(){n.processing=!0;toastr.clear();toastr.info("","Preparing download...");var s=_.sortBy(_.compact(_.uniq(_.map(n.filteredResultsLines,function(n){return n.Material})))),e={},o=[];r.includeMm&&_.forEach(s,function(i){var r=t.defer();o.push(r.promise);n.getMaterialDetails(i).then(function(n){e[i]={};n.data&&(e[i].MMDesc=n.data.MMDesc,e[i].SynergyLevel=n.data.SlInd,e[i].SynergyModel=n.data.SlSupplierPartNum,e[i].SynergySupplier=n.data.SlSupplierName,e[i].SupItemSubcategoryNm=n.data.SupItemSubcategoryNm,e[i].ElectricityUsageInd=n.data.ElectricityUsageInd)}).finally(function(){r.resolve()})});t.all(o).then(function(){}).finally(function(){var t,h,c;_.forEach(n.filteredResultsLines,function(n){!e[n.Material]||(n.SynergyLevel=e[n.Material].SynergyLevel,n.SupItemSubcategoryNm=e[n.Material].SupItemSubcategoryNm,n.ElectricityUsageInd=e[n.Material].ElectricityUsageInd)});t={};h=n.fixedVal.searchXlsx;t.SheetNames=[];t.SheetNames[0]="Sheet1";t.Sheets={};t.Sheets[t.SheetNames[0]]={};var r=t.Sheets[t.SheetNames[0]],o=0,s="";_.forEach(h,function(t){s=u(o);r[s+"1"]={v:t.text,t:"s",z:"General"};var f;_.forEach(n.filteredResultsLines,function(n,u){f={t:t.type,z:t.z};f.v=t.filter?i(t.filter)(n[t.value]):(typeof n[t.value]=="object"?n[t.value].value:n[t.value])||"";r[s+(u+2)]=f});o++});r["!ref"]="A1:"+u(o-1)+(n.filteredResultsLines.length+1);c=XLSX.write(t,{bookType:"xlsx",bookSST:!1,type:"binary"});saveAs(new Blob([f(c)],{type:""}),"OA Search "+moment().format("YYYY.MM.DD HH.mm.ss")+".xlsx");toastr.clear();n.processing=!1;n.filteredResultsLines.length<n.contractLines.length&&toastr.info("","This data is currently filtered. Only the filtered lines have been downloaded.",{timeOut:5e3})})},r.getContractLines=function(){var i,u,r;n.processing||(i="",u="",n.processing=!0,n.contractLines=[],e(),n.search.expanded=!1,n.resultsFilter={},n.orderByField="",n.reverseSort=!1,toastr.clear(),toastr.info("","Retrieving contract data...",{timeOut:0}),i=n.search.type==="both"?"(DocType eq 'ZCON' or DocType eq 'ZQUO')":"DocType eq '"+encodeURIComponent(n.search.type)+"'",n.search.category!=="all"&&(i+=" and PurchOrg eq '"+encodeURIComponent(n.search.category)+"'"),!n.search.contract||(i+=" and Contract eq '"+encodeURIComponent(n.search.contract)+"'",!n.search.line||(i+=" and ItemNo eq '"+encodeURIComponent(n.search.line)+"'")),!n.search.material||(i+=" and Material eq '"+encodeURIComponent(n.search.material)+"'"),!n.search.cm||(i+=" and PurGroup eq '"+encodeURIComponent(n.search.cm.PurGroup)+"'"),!n.search.suppliers||(r=n.search.suppliers.match(/\d+/g),r=_.uniq(r),n.search.suppliers=r.join("\n"),r.length>0&&(i+=" and (Vendor eq '"+r.join("' or Vendor eq '")+"')")),u=i,i+=" and ConditionDataFlag eq 'X' and TextDataFlag eq 'X'",t.all([n.getLines(i),n.getExtensions(u)]).then(function(t){t[0].data=_.filter(t[0].data,function(t){var u;if(!!n.search.line&&n.search.line!==t.ItemNo+""||!!n.search.material&&n.search.material!==t.Material||!!n.search.cm&&n.search.cm.PurGroup!==t.PurGroup.PurGroup||n.search.type==="ZCON"&&t.DocType!=="ZCON"||n.search.type==="ZQUO"&&t.DocType!=="ZQUO"||n.search.type==="both"&&t.DocType!=="ZCON"&&n.search.type==="both"&&t.DocType!=="ZQUO"||n.search.category!=="all"&&n.search.category.toLowerCase()!==t.PurchOrg.value.toLowerCase()||(u=n.search.suppliers.match(/\d+/g),u=_.uniq(u),!!n.search.suppliers&&!_.contains(u,t.Vendor))||!!n.search.mmCategory&&n.search.mmCategory!==t.mmCategory||!!n.search.supplierPart&&t.VendMat.toLowerCase().indexOf(n.search.supplierPart.toLowerCase())===-1||!!n.search.description&&t.ShortText.toLowerCase().indexOf(n.search.description.toLowerCase())===-1||!!n.search.manuf&&t.SIMfrnr.toLowerCase().indexOf(n.search.manuf.toLowerCase())===-1||!!n.search.manufPart&&t.SIMfrpn.toLowerCase().indexOf(n.search.manufPart.toLowerCase())===-1||!!n.search.headerStatus&&n.search.headerStatus!==t.HdrStatus.value||!!n.search.lineDeletion&&(n.search.lineDeletion==="Y"&&!t.DeleteInd||n.search.lineDeletion==="N"&&!!t.DeleteInd)||!!n.search.preferredStatus&&n.search.preferredStatus!==t.SIActive.value||!!n.search.approveStatus&&n.search.approveStatus!==t.SIStatus.value||!!n.search.ccm&&n.search.ccm.PurGroup!==t.HdrBuyerField.PurGroup||!!n.search.referencedContract&&t.ReferencedContract.toLowerCase().indexOf(n.search.referencedContract.toLowerCase())===-1||!!n.search.referencedQuote&&t.ReferencedQuote.toLowerCase().indexOf(n.search.referencedQuote.toLowerCase())===-1)return!1;if(n.search.oaEndType==="from"&&!!n.search.oaDays&&/^-?\d+$/.test(n.search.oaDays)){var i=moment(t.VperEnd).format("MM/DD/YYYY"),r=moment(t.ConditionEnd).format("MM/DD/YYYY"),f=moment().format("MM/DD/YYYY"),e=moment().add("days",n.search.oaDays).format("MM/DD/YYYY");if(n.search.oaDays<0){if(moment(i).isAfter(f,"day")||moment(i).isBefore(e,"day")||moment(r).isAfter(f,"day")||moment(r).isBefore(e,"day"))return!1}else if(moment(i).isBefore(f,"day")||moment(i).isAfter(e,"day")||moment(r).isBefore(f,"day")||moment(r).isAfter(e,"day"))return!1}if(n.search.oaEndType==="between"&&!!n.search.oaEnd1&&!!n.search.oaEnd2&&moment(n.search.oaEnd1).isValid()&&moment(n.search.oaEnd2).isValid()){var i=moment(t.VperEnd).format("MM/DD/YYYY"),r=moment(t.ConditionEnd).format("MM/DD/YYYY"),o=moment(n.search.oaEnd1).format("MM/DD/YYYY"),s=moment(n.search.oaEnd2).format("MM/DD/YYYY");if(moment(i).isBefore(o,"day")||moment(i).isAfter(s,"day")||moment(r).isBefore(o,"day")||moment(r).isAfter(s,"day"))return!1}return!0});var i=n.mapExtensions(t[0].data,t[1].data);!n.search.site||(i=_.filter(i,function(t){return _.where(t.Sites,{site:n.search.site}).length>0}));n.contractLines=i;toastr.clear();n.contractLines.length===0?(n.search.expanded=!0,toastr.warning("","No contract lines were returned",{timeOut:0})):toastr.success("","Contract data retrieved")},function(n){toastr.clear();n.data.hasOwnProperty("error")?toastr.error(n.status+": "+n.data.error.message.value,"",{timeOut:0}):toastr.error("","An error occurred.  Status "+n.status,{timeOut:0})}).finally(function(){n.processing=!1}))},r.getSortClass=function(t){return n.resultsOrderByField!==t?"fa-sort":n.resultsReverseSort?"fa-sort-amount-desc":"fa-sort-amount-asc"},r.sort=function(t){t===n.resultsOrderByField?n.resultsReverseSort=!n.resultsReverseSort:(n.resultsOrderByField=t,n.resultsReverseSort=!1)},r.toggleSearch=function(){n.search.expanded=!n.search.expanded},function(){}(),r}]);app.controller("settings",["dataService","$modalInstance","$q",function(n,t){var i=this;return i.data=n,i.close=function(){t.close()},i.updateSettings=function(){localStorage.setItem("sombrero.settings",JSON.stringify(n.settings))},function(){}(),i}]);app.controller("supplierOwnership",["dataService","$q",function(n){var t=this;return t.data=n,function(){}(),t}]);app.controller("upload",["dataService","$q","$scope","$location",function(n,t,i,r){function f(n){for(var i="",r=new Uint8Array(n),u=r.byteLength,t=0;t<u;t++)i+=String.fromCharCode(r[t]);return window.btoa(i)}function e(n){var t=new FileReader;t.onload=function(t){var r,e,o,s;r=t.target.result;e=u.rABS?XLSX.read(r,{cellNF:!0,cellStyles:!0,type:"binary"}):XLSX.read(f(r),{cellNF:!0,cellStyles:!0,type:"base64"});o=e.SheetNames[0];s=XLSX.utils.sheet_to_json(e.Sheets[o],{raw:!0});i.$apply(u.upload=JSON.stringify(s,null,2));toastr.clear();toastr.success("",n.name+" imported and ready for upload!")};u.rABS?t.readAsBinaryString(n):t.readAsArrayBuffer(n)}var u=this;return u.data=n,u.upload={},u.rABS=typeof FileReader!="undefined"&&typeof FileReader.prototype!="undefined"&&typeof FileReader.prototype.readAsBinaryString!="undefined",u.checkForecasts=function(){n.getForecasts(n.fixedVal.forecast[r.host()]).then(function(n){u.retrieved=n.data})},u.drop=function(n){n.length>1?(toastr.clear(),toastr.error("","Please select only one file.",{timeOut:0})):n.length===1&&(n[0].type!=="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"?(toastr.clear(),toastr.error("","Only XLSX files can be uploaded.",{timeOut:0})):(toastr.clear(),toastr.info("","Importing "+n[0].name,{timeOut:0}),e(n[0])))},function(){}(),u}]);app.controller("workbench",["dataService","$q",function(n){var t=this;return t.data=n,function(){}(),t}]);app.controller("header",["$location","dataService",function(n,t){var i=this;return i.data=t,i.location=n,i}]);app.controller("shell",["$location","$modal","dataService",function(n,t,i){var r=this;return r.data=i,r.checkProdAnalyst=function(){return n.host()==="gwapps.intel.com"&&(_.some(i.roles,{AgrName:"Y_ECC_R2S_L2SUPPORT_PROD_F"})||_.some(i.roles,{AgrName:"Y_ANALYST_F"}))},r.getCmCcmLink=function(){return{"gwappsdev.intel.com":"https://sapfi0ci.intel.com:8300/sap/bc/webdynpro/sap/ywdc_csi_cm_ccm_mapping?sap-client=250&sap-language=EN#","gwappscons.intel.com":"https://sapfc0ci.intel.com:8300/sap/bc/webdynpro/sap/ywdc_csi_cm_ccm_mapping?sap-client=510&sap-language=EN#","gwapps.intel.com":"https://sapfp002.intel.com:8300/sap/bc/webdynpro/sap/ywdc_csi_cm_ccm_mapping?sap-client=510&sap-language=EN#"}[n.host()]},r.getCeDeviationLink=function(){return{"gwappsdev.intel.com":"https://sapfi0ci.intel.com:8300/sap/bc/webdynpro/sap/ywdc_csi_ce_deviation?sap-client=250&sap-language=EN#","gwappscons.intel.com":"https://sapfc0ci.intel.com:8300/sap/bc/webdynpro/sap/ywdc_csi_ce_deviation?sap-client=510&sap-language=EN#","gwapps.intel.com":"https://sapfp002.intel.com:8300/sap/bc/webdynpro/sap/ywdc_csi_ce_deviation?sap-client=510&sap-language=EN#"}[n.host()]},r.isActive=function(t){return t===n.path().substr(0,t.length)},r.openSettings=function(){var n=t.open({templateUrl:"app/modules/settings.html",controller:"settings as vm"});n.result.then(function(){},function(){})},r}]);app.factory("dataService",["$http","$filter","$q",function(n,t,i){function s(n){var i="; "+document.cookie,t=i.split("; "+n+"=");return t.length==2?t.pop().split(";").shift().toUpperCase():""}function h(){return n.get("app/services/fixedVal.json").then(function(n){r.fixedVal=n.data})}function c(){return n.get(u+"YCAP_GET_PURCHASING_GROUPS_SRV/PurchaseGroups?$format=json&$select=PurGroup,Description&u="+moment(),{headers:{"x-csrf-token":"fetch"}}).then(function(n){r.purGroup=n.data.d.results;r.token=n.headers()["x-csrf-token"];_.forEach(r.purGroup,function(n,t){r.purGroup[t]=_.omit(n,"__metadata");r.purGroup[t].Description=r.purGroup[t].Description.trim()})})}function l(){var n;localStorage["sombrero.settings"]&&(r.settings=JSON.parse(localStorage.getItem("sombrero.settings")),n=-1,_.forEach(r.purGroup,function(t,i){_.isEqual(t,r.settings.cm)&&(n=i)}),r.settings.cm=n===-1?"":r.purGroup[n]);localStorage["sombrero.search"]&&(r.search=JSON.parse(localStorage.getItem("sombrero.search")),n=-1,_.forEach(r.purGroup,function(t,i){_.isEqual(t,r.search.cm)&&(n=i)}),r.search.cm=n===-1?"":r.purGroup[n],n=-1,_.forEach(r.purGroup,function(t,i){_.isEqual(t,r.search.ccm)&&(n=i)}),r.search.ccm=n===-1?"":r.purGroup[n]);r.contractRecent=JSON.parse(localStorage.getItem("sombrero.contractRecent"))||[]}function a(){return n.get(u+"YCAP_GET_SECURITY_ROLES_SRV/Roles?$format=json&$select=AgrName,Text&u="+moment(),{headers:{"x-csrf-token":"fetch"}}).then(function(n){r.roles=n.data.d.results;r.token=n.headers()["x-csrf-token"];r.editAllowed=!1;(_.some(r.roles,{AgrName:"Y_CAP_SOURCING_ADMIN_F"})||_.some(r.roles,{AgrName:"Y_ECC_R2S_L2SUPPORT_PROD_F"})||_.some(r.roles,{AgrName:"Y_ANALYST_F"}))&&(r.editAllowed=!0)})}function v(){return n.get("//enterpriseservices.intel.com/SharedServices/cdisapi/v3/workers/").then(function(n){!n.data.WorkerInformation||(r.worker=n.data.WorkerInformation.Worker);r.userId=s("IDSID")})}var u="../../../gw/",f="Contract,DocType,Vendor,VendorName,CompCode,VperStart,VperEnd,PurchOrg,PurGroup,HdrBuyerField,Incoterms1,Incoterms2,ReferencedContract,Currency,ExchRate,SalesPers,Telephone,HdrStatus,HdrReason,DocDate,Pmnttrms,CreatedBy,CreatDate,HdrChangedBy,HdrChangeDate,HdrChangeTime,HdrSirfisFcst",e="Contract,DocType,Vendor,VendorName,VperStart,VperEnd,PurchOrg,PurGroup,HdrBuyerField,ItemNo,Material,ShortText,NetPrice,NetPriceUsd,PriceUnit,PoUnit,OrderprUn,PlanDel,VendMat,SIActive,SIStatus,DeleteInd,SIFcstLt,SIFcstNotice,Currency,ConditionStart,ConditionEnd,ReferencedContract,ReferencedQuote,HdrStatus,SIMfrpn,SIMfrnr,Acctasscat,Incoterms1,Incoterms2,MatlGroup,NoteLongText,Shipping,SICeMarking,SICMApproval,SIITMRequotingTime,SIMinOrderQty,SIModelDiffComment,SIModelDiffJustif,SISiteApproval,SISupplierDiffComment,SISupplierDiffJustif,SITDApproval,SIWipDate,SIWipInd,SIWipStatus,WipNoteText,SICreatedBy,SICreateDate,SIChangedBy,SIChangeDate,SIChangeTime,ScaleBaseType,QuoteDIR",o="Contract,ItemNo,Plant,StgeLoc,DeletionInd,CreatedBy,CreateDate,ChangedBy,ChangeDate,ChangeTime,ShippingCondition",r={};return r.validChars=/^[\w!"%&'()*+,-./:;<=>? ]*$/,r.invalidChars=/[^\w!"%&'()*+,-./:;<=>? ]/,r.resultsOrderByField="Contract",r.resultsReverseSort=!1,r.contractOrderByField="ItemNo",r.contractReverseSort=!1,r.contractCheckAll=!1,r.contractLines=[],r.contract={},r.contractUnchanged={},r.contractReady=!1,r.editContract=!1,r.token="",r.contractRecent=[],r.settings={},r.dashboard={},r.dashboard.bomSite="D1D",r.dashboard.showAllForecasts=!1,r.dashboard.showIndividualForecasts=!1,r.getBom=function(){return n.get(u+"YCAP_BOM_DETAILS_SRV/BOMDetails?$format=json&$select=MMNumber&u="+moment()).then(function(n){return n.data.d.results.length>0?(n.data=n.data.d.results,_.forEach(n.data,function(n){n.value=t("removeZeros")(n.MMNumber)})):n.data=n.data.d.results,n})},r.getDocument=function(i){return n.get(u+"YCAP_DOCUMENT_DETAILS_SRV/Documents?$format=json&$filter=DocumentType eq 'ZQT' and DocumentNumber eq '"+i+"'&$select=Description,Statusextern,Docfile1,CreateDate,QuoteValidFrom,QuoteValidTo,QuoteSupplier&u="+moment()).then(function(n){return n.data=n.data.d.results[0],n.data&&(n.data.Filename=n.data.Docfile1.substr(n.data.Docfile1.lastIndexOf("\\")+1),n.data.CreateDate=t("parseDate")(n.data.CreateDate),n.data.QuoteValidFrom=t("parseDate")(n.data.QuoteValidFrom),n.data.QuoteValidTo=t("parseDate")(n.data.QuoteValidTo)),n})},r.getExtensions=function(t){return n.get(u+"YCAP_CONTRACT_QUERY_SRV/ContractExtensions?$format=json&$filter="+t+"&$select="+o+"&u="+moment(),{headers:{"x-csrf-token":"fetch"}}).then(function(n){return n.data.d.results.length>0?(n.data=n.data.d.results,r.token=n.headers()["x-csrf-token"],_.forEach(n.data,function(n){n.ItemNo=parseInt(n.ItemNo,10);n.ShippingCondition=_.find(r.fixedVal.shipCond,{value:n.ShippingCondition})||_.find(r.fixedVal.shipCond,{"default":"true"})||{value:n.ShippingCondition,text:"",transitTime:""}})):n.data=n.data.d.results,n})},r.getForecasts=function(t){return t==="dev"?n.get("app/services/forecasts.json").then(function(n){return n}):n.jsonp("https://"+t+"/Feed/CsiForecasts?callback=JSON_CALLBACK").then(function(n){return n})},r.getHeader=function(i){return n.get(u+"YCAP_CONTRACT_QUERY_SRV/ContractHeaders?$format=json&$filter="+i+"&$select="+f+"&u="+moment(),{headers:{"x-csrf-token":"fetch"}}).then(function(n){return n.data.d.results.length>0?(n.data=n.data.d.results[0],r.token=n.headers()["x-csrf-token"],n.data.CreatDate=t("parseDate")(n.data.CreatDate),n.data.DocDate=t("parseDate")(n.data.DocDate),n.data.VperStart=t("parseDate")(n.data.VperStart),n.data.VperEnd=t("parseDate")(n.data.VperEnd),n.data.HdrChangeDate=t("parseDate")(n.data.HdrChangeDate),n.data.HdrChangeTime=t("parseTime")(n.data.HdrChangeTime),n.data.ExchRate=parseFloat(n.data.ExchRate),n.data.ExchRate=n.data.ExchRate=n.data.ExchRate/100,n.data.Currency=_.find(r.fixedVal.currency,{value:n.data.Currency})||{value:n.data.Currency,text:n.data.Currency},n.data.Pmnttrms=_.find(r.fixedVal.paymentTerms,{value:n.data.Pmnttrms})||{value:n.data.Pmnttrms,text:n.data.Pmnttrms},n.data.Incoterms1=_.find(r.fixedVal.incoTerms,{value:n.data.Incoterms1})||{value:n.data.Incoterms1,text:n.data.Incoterms1},n.data.PurGroup=_.find(r.purGroup,{PurGroup:n.data.PurGroup})||{PurGroup:n.data.PurGroup,Description:n.data.PurGroup},n.data.HdrBuyerField=_.find(r.purGroup,{PurGroup:n.data.HdrBuyerField})||{PurGroup:n.data.HdrBuyerField,Description:n.data.HdrBuyerField}):n.data=n.data.d.results[0],n})},r.getLines=function(i){return n.get(u+"YCAP_CONTRACT_QUERY_SRV/ContractItems?$format=json&$filter="+i+"&$select="+e+"&u="+moment(),{headers:{"x-csrf-token":"fetch"}}).then(function(n){return n.data.d.results.length>0?(n.data=n.data.d.results,r.token=n.headers()["x-csrf-token"],n.data=_.sortBy(n.data,function(n){return[n.Contract,n.ItemNo]}),_.forEach(n.data,function(n){n.Selected=!1;n.ItemNo=parseInt(n.ItemNo,10);n.DeleteInd=n.DeleteInd==="L"?"X":"";n.Material=t("removeZeros")(n.Material)||"";n.PriceUnit=parseFloat(n.PriceUnit);n.NetPrice=parseFloat(n.NetPrice);n.PlanDel=parseInt(n.PlanDel,10);n.SIFcstLt=t("removeZeros")(n.SIFcstLt)||"";n.SIFcstNotice=t("removeZeros")(n.SIFcstNotice)||"";n.SIITMRequotingTime=t("removeZeros")(n.SIITMRequotingTime)||"";n.ConditionStart=t("parseDate")(n.ConditionStart);n.ConditionEnd=t("parseDate")(n.ConditionEnd);n.VperStart=t("parseDate")(n.VperStart);n.VperEnd=t("parseDate")(n.VperEnd);n.SICreateDate=t("parseDate")(n.SICreateDate);n.SIChangeDate=t("parseDate")(n.SIChangeDate);n.SIChangeTime=t("parseTime")(n.SIChangeTime);n.NetPriceUsd=parseFloat(n.NetPriceUsd);n.SIActive=_.find(r.fixedVal.preferredStatus,{value:n.SIActive})||{value:n.SIActive,text:n.SIActive};n.SIStatus=_.find(r.fixedVal.approveStatus,{value:n.SIStatus})||{value:n.SIStatus,text:n.SIStatus};n.SICMApproval=_.find(r.fixedVal.cmStatus,{value:n.SICMApproval})||{value:n.SICMApproval,text:n.SICMApproval};n.SISiteApproval=_.find(r.fixedVal.siteStatus,{value:n.SISiteApproval})||{value:n.SISiteApproval,text:n.SISiteApproval};n.SITDApproval=_.find(r.fixedVal.tdStatus,{value:n.SITDApproval})||{value:n.SITDApproval,text:n.SITDApproval};n.Incoterms1=_.find(r.fixedVal.incoTerms,{value:n.Incoterms1})||{value:n.Incoterms1,text:n.Incoterms1};n.SICeMarking=_.find(r.fixedVal.ceMarking,{value:n.SICeMarking})||{value:n.SICeMarking,text:n.SICeMarking};n.SIWipDate=t("parseDate")(n.SIWipDate);n.HdrStatus=_.find(r.fixedVal.headerStatus,{value:n.HdrStatus})||{value:n.HdrStatus,text:n.HdrStatus};n.OrderprUn={uom:_.find(r.fixedVal.uom,{value:n.OrderprUn})||{value:n.OrderprUn,text:n.OrderprUn}};n.Shipping=_.find(r.fixedVal.shipInst,{value:n.Shipping})||{value:n.Shipping,text:n.Shipping};n.PurchOrg=t("purchOrg")(n.PurchOrg);n.PurGroup=_.find(r.purGroup,{PurGroup:n.PurGroup})||{PurGroup:n.PurGroup,Description:n.PurGroup};n.HdrBuyerField=_.find(r.purGroup,{PurGroup:n.HdrBuyerField})||{PurGroup:n.HdrBuyerField,Description:n.HdrBuyerField};n.NoteLongText=t("parseLongText")(n.NoteLongText);n.ScaleBaseType=!n.ScaleBaseType?"":"X";n.SIMinOrderQty=parseFloat(n.SIMinOrderQty)===0?"":parseFloat(n.SIMinOrderQty)+""})):n.data=n.data.d.results,n})},r.getMaterialDetails=function(t){return n.get(u+"YCAP_MM_DETAILS_SRV/MMDetails?$format=json&$filter=MMNumber eq '"+t+"'&$select=MMDesc,SlSupplierPartNum,SlSupplierName,SlInd,SupItemSubcategoryNm,ElectricityUsageInd,MMBaseUom&u="+moment()).then(function(n){return n.data=n.data.d.results[0],n})},r.getMaterialPlants=function(t){return n.get(u+"YCAP_MM_DETAILS_SRV/MMPlants?$format=json&$filter=MMNumber eq '"+t+"'&$select=Plant&u="+moment()).then(function(n){return n.data=_.sortBy(_.pluck(n.data.d.results,"Plant")),n})},r.getMaterialUoms=function(t){return n.get(u+"YCAP_MM_DETAILS_SRV/MMAltUOMs?$format=json&$filter=MMNumber eq '"+t+"'&$select=UOM,Numerator,Denominator&u="+moment()).then(function(n){return n.data=n.data.d.results,n})},r.getMaterialPirs=function(t){return n.get(u+"YCAP_MM_DETAILS_SRV/MMPIRs?$format=json&$filter=MMNumber eq '"+t+"'&u="+moment()).then(function(n){return n.data=n.data.d.results,n})},r.initializeSearch=function(){r.search={};r.search.processing=!1;r.search.expanded=!0;r.search.oaEndType="from";r.search.lineEndType="from";r.search.category="all";r.search.type="both";r.search.lineDeletion="";r.search.preferredStatus="";r.search.approveStatus="";r.search.contract="";r.search.line="";r.search.material="";r.search.cm="";r.search.suppliers="";r.search.site=""},r.mapExtensions=function(n,t,i){var u=[];return _.forEach(n,function(n){n.Sites=[];n.SiteString="";u=[];u=_.filter(t,function(t){return n.Contract===t.Contract&&n.ItemNo===t.ItemNo});n.OriginalSites=_.clone(u,!0);u=_.where(u,{DeletionInd:""});_.forEach(u,function(t){var i=[];i=t.StgeLoc?i.concat(_.clone(_.find(r.fixedVal.sites,{plant:t.Plant,sloc:t.StgeLoc}),!0)):i.concat(_.clone(_.where(r.fixedVal.sites,{plant:t.Plant})||t.Plant,!0));i=_.compact(i);i.length>0&&(_.forEach(i,function(n){n.ShippingCondition=t.ShippingCondition}),n.Sites=n.Sites.concat(i))});n.Sites=_.sortBy(n.Sites,"site");n.SiteString=_.pluck(n.Sites,"site").join(", ");!i||(n.AllSites=[],n.AllSites=_.clone(_.where(r.fixedVal.sites,{parentPOrg:i}).length>0?_.where(r.fixedVal.sites,{parentPOrg:i}):_.where(r.fixedVal.sites,{pOrg:i}),!0),n.AllSites.length>0&&_.forEach(n.AllSites,function(t,i){_.some(n.Sites,{plant:t.plant,sloc:t.sloc})?(n.AllSites[i]=_.find(n.Sites,{plant:t.plant,sloc:t.sloc}),n.AllSites[i].Selected=!0):(n.AllSites[i].ShippingCondition=_.find(r.fixedVal.shipCond,{"default":"true"})||{value:"",text:"",transitTime:""},n.AllSites[i].Selected=!1)}),n.BadSites=[],_.forEach(n.Sites,function(t){if(!_.find(n.AllSites,{plant:t.plant,sloc:t.sloc})){var i=_.clone(t,!0);i.Selected=!0;n.BadSites.push(i)}n.BadSites=_.sortBy(n.BadSites,"site")}))}),n},r.fetchToken=function(){return n.get(u+"YCAP_CONTRACT_QUERY_SRV/ContractHeaders?&u="+moment(),{headers:{"x-csrf-token":"fetch"}}).then(function(n){r.token=n.headers()["x-csrf-token"]})},r.size=function(n){return _.size(n)},r.updateContract=function(t,i){return n.post(u+"YCAP_CONTRACT_MAINTAIN_SRV/ContractHeaderSet",t,i).then(function(n){return n})},r.uploadDocument=function(t,i){return n.post(u+"YCAP_DOCUMENT_MAINTAIN_SRV/Documents",t,i).then(function(n){return n})},r.init=function(){if(!r.initialized)return v(),i.all([a(),c(),h()]).then(function(){r.initializeSearch();l();r.initialized=!0},function(){toastr.clear();toastr.error("","An error occurred on load. Please refresh.",{timeOut:0})})},r}]);app.directive("dropTarget",function(){return{restrict:"A",scope:{drop:"&"},link:function(n,t){var i=0;t.bind("dragover",function(n){n.preventDefault&&n.preventDefault();n.stopPropogation&&n.stopPropogation();n.originalEvent.dataTransfer.dropEffect="copy"});t.bind("dragenter",function(n){i++;n.preventDefault&&n.preventDefault();n.stopPropogation&&n.stopPropogation();n.originalEvent.dataTransfer.dropEffect="copy";angular.element(n.currentTarget).addClass("alert-success");angular.element(n.currentTarget).removeClass("alert-info")});t.bind("dragleave",function(n){i--;i===0&&(angular.element(n.currentTarget).addClass("alert-info"),angular.element(n.currentTarget).removeClass("alert-success"));n.preventDefault&&n.preventDefault();n.stopPropogation&&n.stopPropogation();n.originalEvent.dataTransfer.dropEffect="copy"});t.bind("drop",function(t){t.preventDefault&&t.preventDefault();t.stopPropogation&&t.stopPropogation();angular.element(t.currentTarget).addClass("alert-info");angular.element(t.currentTarget).removeClass("alert-success");var i=t.originalEvent.dataTransfer.files;n.$apply(function(){n.drop({files:i})})})}}});app.directive("floatThead",function(){return{restrict:"A",link:function(n,t){$(t).floatThead()}}});app.filter("alphanumeric",["$filter",function(){return function(n){return n.replace(/[^a-z0-9]/gmi,"")}}]);app.filter("csiPsi",["$filter",function(){return function(n){return n==="S044"?"CSI":n==="S048"?"PSI":n}}]);app.filter("deleted",["$filter",function(){return function(n){switch(n){case"X":return'<i class="fa fa-trash-o"><\/i>';case"x":return'<i class="fa fa-trash-o"><\/i>';case"L":return'<i class="fa fa-trash-o"><\/i>';case"l":return'<i class="fa fa-trash-o"><\/i>';case"S":return'<i class="fa fa-lock"><\/i>';case"s":return'<i class="fa fa-lock"><\/i>';default:return"&nbsp;"}}}]);app.filter("display",["$filter","$locale",function(){return function(n){return n?n:""}}]);app.filter("docCategory",["$filter",function(){return function(n){switch(n){case"B":return"PR";case"F":return"PO";default:return""}}}]);app.filter("downloadCmCcm",["$filter",function(){return function(n){return n.Description+" - "+n.PurGroup||""}}]);app.filter("downloadExcelDate",["$filter",function(){return function(n){if(n)return Math.floor(25569+moment(moment(n)-moment().zone()*6e4).valueOf()/864e5)}}]);app.filter("downloadText",["$filter",function(){return function(n){return n.text||""}}]);app.filter("downloadUom",["$filter",function(){return function(n){return n.uom.value||""}}]);app.filter("objToArray",["$filter",function(){return function(n){return(n instanceof Object)?_.values(n):n}}]);app.filter("parseLongText",["$filter",function(){return function(n){return n.replace(/[|]/gmi,"\n")}}]);app.filter("parseDate",["$filter","$locale",function(){return function(n){if(!n)return"";var t;return t=typeof n=="string"&&n.indexOf("/Date")>-1?moment(moment(n).valueOf()+moment(n).zone()*6e4):moment(n),t.format("YYYY/MM/DD")}}]);app.filter("parseDateString",["$filter","$locale",function(){return function(n){if(!n)return"";var t;return t=typeof n=="string"&&n.indexOf("/Date")>-1?moment(moment(n).valueOf()+moment(n).zone()*6e4):moment(n),t.format("MM/DD/YYYY")}}]);app.filter("parseTime",["$filter","$locale",function(){return function(n){return n?n.match(/PT\d\dH\d\dM\d\dS/)?n.substr(2,2)+":"+n.substr(5,2)+":"+n.substr(8,2):n:""}}]);app.filter("porgSite",["$filter",function(){return function(n,t){var i=[];return _.forEach(n,function(n){(t==="all"||n.parentPOrg===t)&&i.push(n)}),i}}]);app.filter("purchOrg",["$filter",function(){return function(n){return n==="S044"?{value:n,text:"CSI"}:n==="S048"?{value:n,text:"PSI"}:{value:n,text:n}}}]);app.filter("releaseStatus",["$filter",function(){return function(n){switch(n){case"C":return'<i class="fa fa-check"><\/i>';case"R":return'<i class="fa fa-times"><\/i>';default:return""}}}]);app.filter("removeZeros",["$filter","$locale",function(){return function(n){for(var t=n+"";t.charAt(0)==="0";)t=t.substring(1,t.length);return t}}]);app.filter("saveLongText",["$filter",function(){return function(n){return n.replace(/[\n]/gmi,"|")}}]);app.filter("selected",["$filter",function(){return function(n){if(!!n&&n.length>0){var t=_.where(n,{Selected:!0});return t.length}return 0}}]);app.filter("showDash",["$filter",function(){return function(n){return!n||n==="0"?"-":n}}]);app.filter("stringDate",["$filter","$locale",function(){return function(n){if(!n)return"";return new Date(n)}}]);app.filter("toX",["$filter",function(){return function(n){return n?"X":""}}]);app.filter("yesNo",["$filter",function(){return function(n){return n?"Yes":"No"}}]);
/*
//# sourceMappingURL=scripts.min.js.map
*/