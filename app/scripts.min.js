"use strict";var app=angular.module("app",["ngRoute","ngSanitize","ui.bootstrap"]);app.config(["$tooltipProvider","$routeProvider","$httpProvider","$locationProvider",function(n,t,i){n.options({popupDelay:500});i.defaults.withCredentials=!0;t.when("/flags",{title:"Flags",templateUrl:"app/modules/flags.html",resolve:{dataService:function(n){return n.init()}}}).when("/flyer",{title:"Flyer",templateUrl:"app/modules/flyer.html",resolve:{dataService:function(n){return n.init()}}}).when("/success",{title:"Thank you",templateUrl:"app/modules/success.html",resolve:{dataService:function(n){return n.init()}}}).when("/calendar",{title:"Calendar",templateUrl:"app/modules/calendar.html",resolve:{dataService:function(n){return n.init()}}}).when("/requirements",{title:"Requirements",templateUrl:"app/modules/requirements.html",resolve:{dataService:function(n){return n.init()}}}).otherwise({redirectTo:"/flags"})}]);app.run(["$route","$rootScope",function(n,t){t.$on("$routeChangeSuccess",function(n,i){t.title="Troop 581 - "+i.$$route.title})}]);toastr.options={closeButton:!1,debug:!1,positionClass:"toast-bottom-left",onclick:null,showDuration:"4000",hideDuration:"1000",timeOut:"4000",extendedTimeOut:"1000",showEasing:"linear",hideEasing:"linear",showMethod:"show",hideMethod:"hide"};app.controller("header",["$location","dataService",function(n,t){var i=this;return i.data=t,i.location=n,i}]);app.controller("shell",["$location","$modal","dataService",function(n,t,i){var r=this;return r.data=i,r.isActive=function(t){return t===n.path().substr(0,t.length)},r.openSettings=function(){var n=t.open({templateUrl:"app/modules/settings.html",controller:"settings as vm"});n.result.then(function(){},function(){})},r}]);app.controller("calendar",["dataService","$q",function(n){var t=this;return t.data=n,function(){}(),t}]);app.controller("flags.boundaries",["dataService","$modalInstance","$q",function(n,t){var i=this;return i.data=n,i.close=function(){t.close()},function(){}(),i}]);app.controller("flags",["dataService","$q","$modal","$timeout","$filter",function(n,t,i,r,u){var f=this;return f.data=n,f.autosave=function(){localStorage.setItem("flags.values",JSON.stringify(n.values))},f.donate=function(t){if(toastr.clear(),!n.values.subscribe&&!n.values.donate){toastr.warning("","You have not selected the flag service or a donation.");t.preventDefault();return}if(n.values.donate&&!n.values.donation){toastr.warning("","You selected to give a donation but did not enter an amount.");t.preventDefault();return}if(n.values.donation&&(!_.toNumber(n.values.donation)||parseInt(n.values.donation,10)<0)){toastr.warning("","Please check your donation amount. It doesn't appear to be correct.");t.preventDefault();return}if(n.values.subscribe&&f.getTotal()<n.cost){toastr.error("","An error occurred. Please fix the data and try again.",{timeOut:0});t.preventDefault();return}if(f.getTotal()<5){toastr.warning("","$5.00 is the minimum amount we can process through PayPal.");t.preventDefault();return}if(!n.values.name||!(n.values.address||!n.values.subscribe)){toastr.warning("","Please fill in all required fields.");t.preventDefault();return}toastr.info("","You will now be sent to PayPal to finish the transaction.",{timeOut:0});r(function(){},5e3)},f.getDescription=function(){var t="";return n.values.subscribe?(t+=n.year+" Flag Subscription",n.values.donate&&n.values.donation&&(t+=" and Donation of "+u("currency")(n.values.donation,"$",2))):n.values.donate&&n.values.donation&&(t+="Donation of "+u("currency")(n.values.donation,"$",2)),t},f.getDonation=function(){return _.toNumber(n.values.donation)?parseInt(n.values.donation,10)<0?0:parseInt(n.values.donation,10):0},f.getTotal=function(){var t=0;return n.values.subscribe&&(t=t+n.cost),n.values.donate&&(t=t+f.getDonation()),t},f.showBoundaries=function(){toastr.clear();var n=i.open({templateUrl:"app/modules/flags.boundaries.html",controller:"flags.boundaries as vm",size:"lg"});n.result.then(function(){},function(){})},function(){n.values=JSON.parse(localStorage.getItem("flags.values"))||{}}(),f}]);app.controller("flyer",["dataService","$q","$modal","$timeout","$filter",function(n){var t=this;return t.data=n,function(){}(),t}]);app.controller("requirements",["dataService","$q","$modal",function(n,t,i){function u(){return n.meritBadgesTemp={},n.getWebpage(r.meritBadgeUrl,"ol","json").then(function(i){var r;return i=_.castArray(i),_.forEach(i,function(n){if(n.li&&n.li.length>100)return r=n.li,!1}),_.forEach(r,function(t){_.has(t,"a.content")?n.meritBadgesTemp[t.a.content]={name:t.a.content,url:"meritbadge.org"+_.get(t,"a.href"),encodedName:_.replace(_.get(t,"a.href"),"/wiki/index.php/",""),type:"Merit Badge"}:_.has(t,"i.b.a.content")&&(n.meritBadgesTemp[t.i.b.a.content]={name:t.i.b.a.content,url:"meritbadge.org"+_.get(t,"i.b.a.href"),encodedName:_.replace(_.get(t,"i.b.a.href"),"/wiki/index.php/",""),type:"Merit Badge",required:!0})}),t.all(_.map(n.meritBadgesTemp,function(i){return t.all({requirements:n.getWebpage(i.url,"table","xml").then(function(t){var r=$(t).find("table").has(".mw-headline"),f=$(r).find("tr:first")[0]&&$(r).find("tr:first")[0].outerHTML||"",e=$(r).find("table:last")[0]&&$(r).find("table:last")[0].outerHTML||"",o=$(r).find("div:last")[0]&&$(r).find("div:last")[0].outerHTML||"",u=$(t).find("table").has(".mw-headline")[0].outerHTML,u=_.replace(u,f,""),u=_.replace(u,e,""),u=_.replace(u,o,"");n.meritBadgesTemp[i.name].requirements=u}),image:n.getWebpage(i.url,"img","json").then(function(t){var r;t=_.castArray(t);_.forEach(t,function(n){if(n.src&&_.includes(n.src,i.encodedName))return r=n,!1});r&&(n.meritBadgesTemp[i.name].imgUrl="//meritbadge.org"+r.src)})}).then(function(){n.meritBadgesTemp[i.name].ready=!0;n.meritBadges[i.name]=n.meritBadgesTemp[i.name]},function(t){console.log(i.name+" failed: "+t);n.failures.meritBadges.push(i)})})).finally(function(){localStorage.setItem("meritBadges",JSON.stringify(n.meritBadges))})})}function f(){return n.ranksTemp={Scout:{order:1,name:"Scout",url:"meritbadge.org/wiki/index.php/Scout_Badge",encodedName:"BoyScout",type:"Rank"},Tenderfoot:{order:2,name:"Tenderfoot",url:"meritbadge.org/wiki/index.php/Tenderfoot_rank",encodedName:"Tenderfoot",type:"Rank"},"Second Class":{order:3,name:"Second Class",url:"meritbadge.org/wiki/index.php/Second_Class_rank",encodedName:"SecondClass",type:"Rank"},"First Class":{order:4,name:"First Class",url:"meritbadge.org/wiki/index.php/First_Class_rank",encodedName:"FirstClass",type:"Rank"},Star:{order:5,name:"Star",url:"meritbadge.org/wiki/index.php/Star_rank",encodedName:"Star",type:"Rank"},Life:{order:6,name:"Life",url:"meritbadge.org/wiki/index.php/Life_rank",encodedName:"Life",type:"Rank"},Eagle:{order:7,name:"Eagle",url:"meritbadge.org/wiki/index.php/Eagle_Scout_rank",encodedName:"EagleScout",type:"Rank"},"Eagle Palms":{order:8,name:"Eagle Palms",url:"meritbadge.org/wiki/index.php/Eagle_Palms",encodedName:"Eagle_Palms",type:"Palm"}},t.all(_.map(n.ranksTemp,function(i){return t.all({requirements:n.getWebpage(i.url,"table","xml").then(function(t){var r=$(t).find("table").has(".mw-headline"),f=$(r).find("tr:first")[0]&&$(r).find("tr:first")[0].outerHTML||"",e=$(r).find("table:last")[0]&&$(r).find("table:last")[0].outerHTML||"",o=$(r).find("div:last")[0]&&$(r).find("div:last")[0].outerHTML||"",u=$(t).find("table").has(".mw-headline")[0].outerHTML,u=_.replace(u,f,""),u=_.replace(u,e,""),u=_.replace(u,o,"");n.ranksTemp[i.name].requirements=u}),image:n.getWebpage(i.url,"img","json").then(function(t){var r;t=_.castArray(t);_.forEach(t,function(n){if(n.src&&_.includes(n.src,i.encodedName))return r=n,!1});r&&(n.ranksTemp[i.name].imgUrl="//meritbadge.org"+r.src)})}).then(function(){n.ranksTemp[i.name].ready=!0;n.ranks[i.name]=n.ranksTemp[i.name]},function(t){console.log(i.name+" failed: "+t);n.failures.ranks.push(i)})})).finally(function(){localStorage.setItem("ranks",JSON.stringify(n.ranks))})}var r=this;return r.data=n,r.meritBadgeUrl="meritbadge.org/wiki/index.php/Merit_Badges",r.rankUrl="meritbadge.org/wiki/index.php/Main_Page",r.refresh=function(){return n.processingRequirements=!0,n.failures={ranks:[],meritBadges:[]},t.all({ranks:f(),meritBadges:u()}).finally(function(){n.processingRequirements=!1})},r.showRequirements=function(n){var t=i.open({templateUrl:"app/modules/requirements.show.html",controller:"requirements.show as vm",size:"lg",resolve:{badge:function(){return n}}});t.result.then(function(){},function(){})},function(){!n.processingRequirements&&_.isEmpty(n.meritBadges)&&_.isEmpty(n.ranks)&&r.refresh()}(),r}]);app.controller("requirements.show",["dataService","$modalInstance","$q","badge",function(n,t,i,r){var u=this;return u.data=n,u.title="",u.badge=r,u.close=function(){t.close()},t.rendered.then(function(){$("#requirements").html(r.requirements);$("#requirements table").removeAttr("style");$("#requirements a").replaceWith(function(){return $(this)[0].innerText})}),function(){}(),u}]);app.controller("success",["dataService","$q","$modal","$timeout","$filter",function(n){var t=this;return t.data=n,function(){}(),t}]);app.factory("dataService",["$http","$filter","$q",function(n){function r(n,t,i,r){var u=moment().year(r).month(i).date(1).hours(0).minutes(0).seconds(0).milliseconds(0);if(n===-1)for(u.endOf("month").startOf("day");u.day()!==t;)u.subtract(1,"day");else for(u.date((n-1)*7+1);u.day()!==t;)u.add(1,"day");return u}var t={};t.year=2017;t.cost=45;t.meritBadges={};t.values={};var i=1,u=3;return t.holidays=[{text:"Memorial Day",date:r(-1,i,4,t.year),dateNoYear:"Last Monday in May"},{text:"Flag Day",date:moment(t.year+"-06-14"),dateNoYear:"June 14th"},{text:"Independence Day",date:moment(t.year+"-07-04"),dateNoYear:"July 4th"},{text:"Patriot Day",date:moment(t.year+"-09-11"),dateNoYear:"September 11th"},{text:"Columbus Day",date:r(2,i,9,t.year),dateNoYear:"Second Monday in October"},{text:"Veterans Day",date:moment(t.year+"-11-11"),dateNoYear:"November 11th"},{text:"Martin Luther King, Jr. Day",date:r(u,i,0,t.year+1),dateNoYear:"Third Monday in January"},{text:"Presidents' Day",date:r(u,i,1,t.year+1),dateNoYear:"Third Monday in February"}],t.getWebpage=function(t,i,r){return n.get("https://query.yahooapis.com/v1/public/yql?q=select%20*%20from%20html%20where%20url%3D'"+encodeURI(t)+"'%20and%20xpath%3D'%2F%2F"+i+"'&format="+r+"&env=store%3A%2F%2Fdatatables.org%2Falltableswithkeys",{withCredentials:!1}).then(function(n){return r==="json"?n.data.query.results[i]:$.parseXML(n.data)})},t.processDonation=function(t){return n.get(t).then(function(n){return n})},t.init=function(){t.ranks=JSON.parse(localStorage.getItem("ranks"))||{};t.meritBadges=JSON.parse(localStorage.getItem("meritBadges"))||{}},t}]);app.directive("dropTarget",function(){return{restrict:"A",scope:{drop:"&"},link:function(n,t){var i=0;t.bind("dragover",function(n){n.preventDefault&&n.preventDefault();n.stopPropogation&&n.stopPropogation();n.originalEvent.dataTransfer.dropEffect="copy"});t.bind("dragenter",function(n){i++;n.preventDefault&&n.preventDefault();n.stopPropogation&&n.stopPropogation();n.originalEvent.dataTransfer.dropEffect="copy";angular.element(n.currentTarget).addClass("alert-success");angular.element(n.currentTarget).removeClass("alert-info")});t.bind("dragleave",function(n){i--;i===0&&(angular.element(n.currentTarget).addClass("alert-info"),angular.element(n.currentTarget).removeClass("alert-success"));n.preventDefault&&n.preventDefault();n.stopPropogation&&n.stopPropogation();n.originalEvent.dataTransfer.dropEffect="copy"});t.bind("drop",function(t){t.preventDefault&&t.preventDefault();t.stopPropogation&&t.stopPropogation();angular.element(t.currentTarget).addClass("alert-info");angular.element(t.currentTarget).removeClass("alert-success");var i=t.originalEvent.dataTransfer.files;n.$apply(function(){n.drop({files:i})})})}}});app.directive("floatThead",function(){return{restrict:"A",link:function(n,t){$(t).floatThead()}}});app.filter("momentToString",["$filter","$locale",function(){return function(n,t){return moment.isMoment(n)?n.format(t):""}}]);app.filter("objToArray",["$filter",function(){return function(n){return(n instanceof Object)?_.values(n):n}}]);app.filter("porgSite",["$filter",function(){return function(n,t){var i=[];return _.forEach(n,function(n){(t==="all"||n.parentPOrg===t)&&i.push(n)}),i}}]);